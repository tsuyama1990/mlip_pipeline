# CYCLE 04 Specification: Structure Generator

## 1. Summary

Cycle 04 implements the "Explorer" (Structure Generator), the engine responsible for proposing new atomic configurations to learn. Unlike simple random search, this module uses an "Adaptive Exploration Policy" to decide *how* to sample the configuration space. Based on the material type (e.g., metal vs. insulator) and current uncertainty state, it dynamically selects strategies such as High-Temperature MD, Random Displacement, or Defect Injection (Vacancies/Interstitials). This ensures that the potential is trained on physically relevant high-energy configurations, not just equilibrium states.

## 2. System Architecture

```ascii
src/mlip_autopipec/
├── services/
│   └── structure_gen/
│       ├── __init__.py
│       ├── explorer.py          # [CREATE] AdaptiveExplorer implementation
│       ├── policy.py            # [CREATE] Policy logic (Decision Tree)
│       └── strategies/
│           ├── __init__.py
│           ├── base.py          # [CREATE] Abstract Strategy
│           ├── random_disp.py   # [CREATE] Random Displacement
│           ├── defects.py       # [CREATE] Vacancy/Interstitial logic
│           └── md_sampling.py   # [CREATE] Short MD burst logic
```

## 3. Design Architecture

### Adaptive Explorer (`explorer.py`)
-   **Role**: Context manager for strategies.
-   **Logic**:
    1.  Analyze input structure (e.g., calculate estimated Band Gap or Bulk Modulus).
    2.  Query `PolicyEngine` to get the next action (e.g., "Generate 5 vacancies").
    3.  Delegate to the appropriate `Strategy` implementation.

### Policy Engine (`policy.py`)
-   **Input**: `StructureMetadata`, `ExplorationConfig`.
-   **Output**: List of `(StrategyName, Parameters)`.
-   **Example Rule**: If `cycle < 2`, use `RandomDisplacement` (Rattling) to learn elasticity. If `cycle >= 2`, use `Defects` to learn chemistry.

### Strategies
-   `RandomDisplacement`: Displaces atoms by Gaussian noise ($\sigma = 0.05 \AA$).
-   `DefectGenerator`: Removes $N$ atoms (vacancy) or adds species (interstitial) or swaps (antisite).
-   `MDSampling`: Runs a short, high-temperature MD burst using a rough potential (or LJ) to get "melted" or "disordered" structures.

## 4. Implementation Approach

1.  **Implement Strategies**:
    -   Write `DefectGenerator` using ASE's manipulation functions (`pop`, `append`).
    -   Write `RandomDisplacement` using `atoms.rattle()`.

2.  **Implement Policy Logic**:
    -   Create a simple rule-based system initially (Cycle-based schedule).
    -   Example: Cycle 1=Rattle, Cycle 2=Vacancies, Cycle 3=HighT.

3.  **Integrate with Orchestrator**:
    -   Replace `MockExplorer` with `AdaptiveExplorer`.

## 5. Test Strategy

### Unit Testing
-   **Defect Generation**: Verify that asking for a vacancy reduces atom count by 1.
-   **Rattling**: Verify that atomic positions change but the cell remains the same.
-   **Policy**: Verify that the policy returns the correct strategy name for a given cycle number.

### Integration Testing
-   **Pipeline Integration**: Ensure that the structures generated by the Explorer can be successfully serialized by the `DatasetManager` (Cycle 02) and processed by the `Oracle` (Cycle 03).
