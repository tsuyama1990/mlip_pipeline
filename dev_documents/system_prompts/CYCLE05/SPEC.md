# Cycle 05 Specification: Dynamics (LAMMPS) & Uncertainty Watchdog

## 1. Summary

Cycle 05 implements the **Dynamics Engine**, which drives the active learning process by running molecular dynamics (MD) simulations. This engine uses the **LAMMPS** code, interfaced via Python. Crucially, this cycle implements two major safety features:

1.  **Hybrid Potential Application**: We never run the ACE potential alone. We overlay it with a ZBL (Universal Repulsive) potential using `pair_style hybrid/overlay`. This ensures that if atoms get too close (where ACE data is sparse), the physics-based ZBL repulsion kicks in, preventing non-physical fusion and simulation crashes.
2.  **Uncertainty Watchdog**: We use the `compute pace` command to calculate the extrapolation grade ($\gamma$) for every atom at every step. We use `fix halt` to automatically stop the simulation if any atom's $\gamma$ exceeds a safety threshold.

## 2. System Architecture

### File Structure

Files in **bold** are new or modified in this cycle.

```ascii
src/mlip_autopipec/
├── components/
│   ├── dynamics/
│   │   ├── **__init__.py**
│   │   ├── **base.py**          # BaseDynamics class
│   │   ├── **lammps_driver.py** # LAMMPS Python Interface
│   │   └── **input_gen.py**     # LAMMPS input script generator
│   └── mock.py
├── domain_models/
│   └── config.py                # Updated with DynamicsConfig
└── core/
    └── orchestrator.py          # Updated to use Dynamics
```

### Component Interaction
1.  **Orchestrator** loads the latest `potential.yace`.
2.  **Orchestrator** calls `dynamics.run_exploration(structure, potential)`.
3.  **Dynamics** generates a LAMMPS input script (`input_gen.py`) that includes:
    -   `pair_style hybrid/overlay pace zbl`
    -   `compute max_gamma all pace ... gamma_mode=1`
    -   `fix watchdog all halt 10 v_max_gamma > 5.0`
4.  **Dynamics** executes LAMMPS via `lammps_driver.py`.
5.  **Dynamics** captures the result:
    -   If finished normally: "Converged".
    -   If halted: Returns the snapshot of the structure where the halt occurred.

## 3. Design Architecture

### 3.1. Dynamics Configuration (`domain_models/config.py`)

```python
class DynamicsConfig(BaseComponentConfig):
    binary_path: str = "lmp"
    uncertainty_threshold: float = 5.0
    timestep: float = 0.001  # ps
    n_steps: int = 100000
    temperature: float = 300.0
```

### 3.2. Hybrid Potential Logic (`components/dynamics/input_gen.py`)

We need to dynamically generate the `pair_coeff` lines based on the elements in the system.

```lammps
# Generated by PyAceMaker
pair_style hybrid/overlay pace zbl 1.0 2.0
pair_coeff * * pace potential.yace Li O
pair_coeff 1 1 zbl 3.0 3.0  # Li-Li
pair_coeff 1 2 zbl 3.0 8.0  # Li-O
pair_coeff 2 2 zbl 8.0 8.0  # O-O
```

### 3.3. Watchdog Logic

The watchdog relies on LAMMPS's internal variable evaluation.

```lammps
compute pace_gamma all pace potential.yace gamma_mode=1
variable max_gamma equal max(c_pace_gamma)
fix watchdog all halt 10 v_max_gamma > ${threshold} error hard
```
Note: `error hard` causes LAMMPS to exit with a specific error code, which our Python driver catches.

## 4. Implementation Approach

1.  **Implement Input Generator**: Create `input_gen.py`. It should take a `Structure` and `DynamicsConfig` and return a string (the input script).
2.  **Implement LAMMPS Driver**:
    -   Prefer using the `lammps` Python module (`from lammps import lammps`) if available.
    -   Fallback to `subprocess.run(["lmp", "-in", "in.lammps"])` if not.
    -   Important: Handle the `fix halt` exit code gracefully.
3.  **Implement Hybrid Logic**: Hardcode ZBL parameters (atomic numbers) for all elements.
4.  **Mock Dynamics**:
    -   Simulation of a "Halt": Randomly decide to stop early and return a "high uncertainty" structure.
    -   Simulation of "Convergence": Run to end.
5.  **Orchestrator Integration**: Add the exploration step.

## 5. Test Strategy

### 5.1. Unit Testing
-   **Input Generation**: Verify that the generated LAMMPS script contains the correct `pair_style`, `pair_coeff`, and `fix halt` commands.
-   **ZBL Parameters**: Verify correct atomic numbers are assigned for a given element list.

### 5.2. Integration Testing
-   **Mock Halt**: Configure Mock Dynamics to halt at step 50. Verify Orchestrator receives the "Halt" signal and the structure.
-   **Real LAMMPS (Optional)**: If `lammps` with USER-PACE package is installed, run a short run. (Likely skipped in standard CI).
