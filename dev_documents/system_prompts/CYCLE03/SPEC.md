# Cycle 03 Specification: The Structure Generator (Exploration Phase 1)

## 1. Summary

Cycle 03 implements the "Explorer" component, responsible for generating the diverse atomic configurations required to train a robust potential. A machine learning potential is only as good as the data it sees; therefore, the Explorer must sample not just the equilibrium states but also the "uncomfortable" regions of the potential energy surface (PES)—such as high-temperature liquids, strained lattices, and defect structures. This cycle delivers the base `AdaptiveExplorer` class and a suite of primitive generation strategies (`RandomDisplacement`, `Strain`, `MDWrapper`). While the "Active" part of the loop comes later, this cycle establishes the mechanism to propose structures efficiently.

## 2. System Architecture

### 2.1 File Structure

**Bold** files are to be created or modified in this cycle.

```text
.
├── src/
│   └── mlip_autopipec/
│       ├── physics/
│       │   ├── structure_gen/
│       │   │   ├── **__init__.py**
│       │   │   ├── **explorer.py**     # Main AdaptiveExplorer
│       │   │   ├── **strategies.py**   # Generation algorithms
│       │   │   └── **dataset.py**      # Dataset management
│       │   └── **__init__.py**
│       └── orchestration/
│           └── **orchestrator.py**     # Connect Explorer
└── tests/
    ├── unit/
    │   └── **test_structure_gen.py**
    └── integration/
        └── **test_exploration_cycle.py**
```

## 3. Design Architecture

### 3.1 `AdaptiveExplorer` Class
-   **Role**: Manages the portfolio of exploration strategies.
-   **Responsibilities**:
    -   Maintain a set of "Seed Structures" (initial guess).
    -   Select a strategy based on configuration (later, this will be adaptive).
    -   Execute the strategy to produce `N` candidate structures.
    -   Assign unique metadata (`StructureMetadata`) to each generated structure (e.g., "Generated by Strain Strategy from Parent ID 123").

### 3.2 Strategy Pattern (`strategies.py`)
We implement a `GenerationStrategy` abstract base class with concrete implementations:
1.  **`RandomDisplacementGenerator`**: Adds Gaussian noise to atomic positions. Useful for sampling local vibrations (phonons).
2.  **`StrainGenerator`**: Applies deformation tensors (shear/volumetric) to the simulation cell. Critical for learning elastic constants.
3.  **`MDGenerator`**: Wraps a simple MD run (using ASE's internal `Langevin` or `VelocityVerlet` dynamics initially) to sample liquid/amorphous states.
    -   *Note*: In Cycle 05, this will be upgraded to run LAMMPS with the ACE potential. For Cycle 03, we use a simple pair potential (LJ/EMT) or just random thermalization to generate geometry.

### 3.3 Data Persistence (`dataset.py`)
-   Structures must be saved in `.xyz` or `.extxyz` format to preserve extra columns (arrays).
-   We need a `DatasetManager` to append new structures to the training pool without duplication.

## 4. Implementation Approach

1.  **Strategy Implementation**:
    -   Implement `RandomDisplacementGenerator.apply(atoms, magnitude=0.1)`.
    -   Implement `StrainGenerator.apply(atoms, strain_tensor)`.
    -   Implement `DefectGenerator.apply(atoms)`: randomly remove an atom (vacancy) or swap species (antisite).

2.  **Explorer Logic**:
    -   `AdaptiveExplorer.generate(count)`:
        1. Pick a seed structure.
        2. Pick a strategy (randomly for now).
        3. Apply strategy.
        4. Wrap in `StructureMetadata`.
        5. Return list.

3.  **Orchestrator Integration**:
    -   Update `Orchestrator` to replace `MockExplorer` with the real `AdaptiveExplorer`.
    -   In the `run_cycle` method, call `explorer.generate()` and save the output to `active_learning/iter_XX/candidates.xyz`.

4.  **Configuration**:
    -   Update `config_model.py` to include `StructureGenConfig` (e.g., `n_candidates`, `perturbation_magnitude`).

## 5. Test Strategy

### 5.1 Unit Testing
-   **`test_structure_gen.py`**:
    -   **Strain**: Apply 5% tension. Check if cell vectors increased by 5%.
    -   **Displacement**: Apply 0.1A rattle. Check if positions changed but cell is same.
    -   **Metadata**: Ensure the generated `Atoms.info` dict contains `parent_id` and `generation_method`.

### 5.2 Integration Testing
-   **`test_exploration_cycle.py`**:
    -   Start with a single FCC Copper atom.
    -   Run the Explorer to generate 10 candidates using `RandomDisplacement`.
    -   Verify that 10 structures are produced.
    -   Verify they are distinct (positions differ).
    -   Verify they can be written/read to XYZ file without loss of info.
