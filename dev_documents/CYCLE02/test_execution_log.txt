============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
plugins: mock-3.15.1, cov-7.0.0
collected 51 items

tests/unit/test_config.py ..............                                 [ 27%]
tests/unit/test_database.py .....                                        [ 37%]
tests/unit/test_explorer_config.py ...                                   [ 43%]
tests/unit/test_generator_schemas.py .......                             [ 56%]
tests/unit/test_generator_strategies.py ........                         [ 72%]
tests/unit/test_structure_builder.py ....                                [ 80%]
tests/e2e/test_cli.py ......                                             [ 92%]
tests/e2e/test_generator_uat.py ..FF                                     [100%]

=================================== FAILURES ===================================
_________________________ test_uat_2_3_defect_vacancy __________________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-10/test_uat_2_3_defect_vacancy0')

    def test_uat_2_3_defect_vacancy(tmp_path):
        """
        Scenario 2.3: Defect Generation (Vacancies)
        """
        db_path = tmp_path / "mlip.db"
        pseudo_dir = tmp_path / "pseudos"
        pseudo_dir.mkdir()

        config_data = {
            "target_system": {
                "name": "Cu",
                "elements": ["Cu"],
                "composition": {"Cu": 1.0},
                "crystal_structure": "fcc"
            },
            "generator_config": {
                "sqs": {"enabled": True, "supercell_size": [2, 2, 2]},
                "distortion": {"enabled": False},
                "defects": {
                    "enabled": True,
                    "vacancies": True,
                    "interstitials": False
                },
                "number_of_structures": 10
            },
            "dft": {"pseudopotential_dir": str(pseudo_dir), "ecutwfc": 30, "kspacing": 0.15},
            "runtime": {"database_path": str(db_path), "work_dir": str(tmp_path)}
        }

        config_file = tmp_path / "input.yaml"
        with open(config_file, "w") as f:
            yaml.dump(config_data, f)

        runner.invoke(app, ["db", "init", "--config", str(config_file)])
        result = runner.invoke(app, ["generate", "--config", str(config_file)])
        print(f"STDOUT: {result.stdout}")
        assert result.exit_code == 0

        with DatabaseManager(db_path) as db:
            count = db.count()
            print(f"DB Count: {count}")
            # SQS (32 atoms) -> Base
            # Vacancies -> 32 structures
            # Total 1 + 32 = 33 structures. Limit 10 -> sampled.
>           assert count == 10
E           assert 9 == 10

tests/e2e/test_generator_uat.py:152: AssertionError
----------------------------- Captured stdout call -----------------------------
STDOUT: Generated 9 structures.
Saved to /tmp/pytest-of-jules/pytest-10/test_uat_2_3_defect_vacancy0/mlip.db

DB Count: 9
_______________________ test_uat_2_4_defect_interstitial _______________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-10/test_uat_2_4_defect_interstiti0')

    def test_uat_2_4_defect_interstitial(tmp_path):
        """
        Scenario 2.4: Defect Generation (Interstitials)
        """
        db_path = tmp_path / "mlip.db"
        pseudo_dir = tmp_path / "pseudos"
        pseudo_dir.mkdir()

        config_data = {
            "target_system": {
                "name": "Fe",
                "elements": ["Fe"],
                "composition": {"Fe": 1.0},
                "crystal_structure": "bcc"
            },
            "generator_config": {
                "sqs": {"enabled": False}, # Primitive
                "distortion": {"enabled": False},
                "defects": {
                    "enabled": True,
                    "vacancies": False,
                    "interstitials": True,
                    "interstitial_elements": ["H"]
                },
                "number_of_structures": 10
            },
            "dft": {"pseudopotential_dir": str(pseudo_dir), "ecutwfc": 30, "kspacing": 0.15},
            "runtime": {"database_path": str(db_path), "work_dir": str(tmp_path)}
        }

        config_file = tmp_path / "input.yaml"
        with open(config_file, "w") as f:
            yaml.dump(config_data, f)

        runner.invoke(app, ["db", "init", "--config", str(config_file)])
        result = runner.invoke(app, ["generate", "--config", str(config_file)])
        print(f"STDOUT: {result.stdout}")
        assert result.exit_code == 0

        with DatabaseManager(db_path) as db:
            # Primitive BCC Fe has 1 atom (if using ase.build.bulk without cubic=True? No, default is primitive)
            # Or 2 atoms if cubic=True?
            # Using "crystal_structure": "bcc" calls _generate_bulk_base -> bulk("Fe").
            # ase.build.bulk("Fe") defaults to BCC primitive (1 atom).
            # Voronoi needs >4 atoms. Fallback logic runs.
            # It generates candidates.

            # Check we have interstitials
            count_int = db.count(selection="config_type=interstitial")
            print(f"Interstitials: {count_int}")
>           assert count_int > 0
E           assert 0 > 0

tests/e2e/test_generator_uat.py:205: AssertionError
----------------------------- Captured stdout call -----------------------------
STDOUT: Generated 1 structures.
Saved to /tmp/pytest-of-jules/pytest-10/test_uat_2_4_defect_interstiti0/mlip.db

Interstitials: 0
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.12-final-0 _______________

Name                                             Stmts   Miss  Cover   Missing
------------------------------------------------------------------------------
mlip_autopipec/__init__.py                           4      0   100%
mlip_autopipec/app.py                               74     14    81%   33-34, 71-73, 95-96, 112-114, 132-134, 138
mlip_autopipec/config/__init__.py                    3      0   100%
mlip_autopipec/config/factory.py                    37     37     0%   1-62
mlip_autopipec/config/models.py                     52      0   100%
mlip_autopipec/config/schemas/common.py             31      1    97%   26
mlip_autopipec/config/schemas/dft.py                20      1    95%   25
mlip_autopipec/config/schemas/exploration.py         5      0   100%
mlip_autopipec/config/schemas/generator.py          26      0   100%
mlip_autopipec/config/schemas/inference.py          20      1    95%   28
mlip_autopipec/config/schemas/orchestration.py       5      0   100%
mlip_autopipec/config/schemas/surrogate.py           7      0   100%
mlip_autopipec/config/schemas/training.py            5      0   100%
mlip_autopipec/core/__init__.py                      0      0   100%
mlip_autopipec/core/database.py                    118     62    47%   59, 66-76, 80, 99, 105-109, 119-121, 131-134, 138-145, 150, 152, 159-177, 181, 185-190, 194-204
mlip_autopipec/core/logging.py                      11      4    64%   24-29
mlip_autopipec/core/services.py                     11      2    82%   24, 30
mlip_autopipec/core/workspace.py                    13     13     0%   1-25
mlip_autopipec/data/__init__.py                      0      0   100%
mlip_autopipec/data/database.py                     23     23     0%   7-73
mlip_autopipec/data_models/__init__.py               4      4     0%   9-13
mlip_autopipec/data_models/candidate.py             10     10     0%   1-19
mlip_autopipec/data_models/dft_models.py            35     35     0%   1-45
mlip_autopipec/data_models/inference_models.py      18     18     0%   1-34
mlip_autopipec/data_models/structure_enums.py        9      9     0%   1-11
mlip_autopipec/data_models/training_data.py         59     59     0%   2-95
mlip_autopipec/data_models/types.py                 10     10     0%   1-14
mlip_autopipec/dft/__init__.py                       0      0   100%
mlip_autopipec/dft/constants.py                      3      3     0%   1-91
mlip_autopipec/dft/inputs.py                        57     57     0%   1-166
mlip_autopipec/dft/parsers.py                       21     21     0%   5-83
mlip_autopipec/dft/recovery.py                      30     30     0%   1-81
mlip_autopipec/dft/runner.py                        79     79     0%   1-170
mlip_autopipec/exceptions.py                        25      8    68%   43-48, 51-52, 65
mlip_autopipec/generator/__init__.py                 5      0   100%
mlip_autopipec/generator/builder.py                113     26    77%   45-46, 77-78, 89, 91, 95-105, 120-125, 161-165, 217-218, 230-231
mlip_autopipec/generator/defects.py                 82     19    77%   97-108, 145-152, 178-180
mlip_autopipec/generator/molecule.py                54     41    24%   49-120
mlip_autopipec/generator/sqs.py                     44      8    82%   55, 79-82, 94-96
mlip_autopipec/generator/transformations.py         46     16    65%   45-54, 91-96
mlip_autopipec/inference/__init__.py                 9      9     0%   8-17
mlip_autopipec/inference/analysis.py                44     44     0%   8-88
mlip_autopipec/inference/embedding.py               53     53     0%   1-105
mlip_autopipec/inference/inputs.py                  19     19     0%   7-71
mlip_autopipec/inference/interfaces.py               5      5     0%   5-17
mlip_autopipec/inference/lammps_runner.py           45     45     0%   8-108
mlip_autopipec/inference/masking.py                 33     33     0%   1-76
mlip_autopipec/inference/uq.py                      23     23     0%   1-38
mlip_autopipec/inference/writer.py                  20     20     0%   7-58
mlip_autopipec/modules/__init__.py                   0      0   100%
mlip_autopipec/modules/config_generator.py          15     15     0%   3-74
mlip_autopipec/modules/descriptors.py               31     31     0%   3-62
mlip_autopipec/modules/dft.py                       67     67     0%   6-189
mlip_autopipec/modules/exploration.py               51     51     0%   7-130
mlip_autopipec/modules/explorer.py                  46     46     0%   3-90
mlip_autopipec/modules/generator.py                 72     72     0%   3-203
mlip_autopipec/modules/inference.py                136    136     0%   7-333
mlip_autopipec/modules/screening.py                 41     41     0%   3-68
mlip_autopipec/modules/training.py                  94     94     0%   9-234
mlip_autopipec/monitoring/__init__.py                0      0   100%
mlip_autopipec/monitoring/dashboard.py              63     63     0%   1-115
mlip_autopipec/orchestration/__init__.py             5      5     0%   1-6
mlip_autopipec/orchestration/dashboard.py           47     47     0%   1-110
mlip_autopipec/orchestration/interfaces.py           9      9     0%   1-29
mlip_autopipec/orchestration/manager.py             66     66     0%   1-128
mlip_autopipec/orchestration/models.py              18     18     0%   1-50
mlip_autopipec/orchestration/phase_executor.py      80     80     0%   1-133
mlip_autopipec/orchestration/task_queue.py          74     74     0%   1-151
mlip_autopipec/surrogate/__init__.py                 0      0   100%
mlip_autopipec/surrogate/candidate_manager.py       14     14     0%   1-37
mlip_autopipec/surrogate/descriptors.py             30     30     0%   1-84
mlip_autopipec/surrogate/mace_client.py             62     62     0%   1-146
mlip_autopipec/surrogate/pipeline.py                54     54     0%   1-118
mlip_autopipec/surrogate/sampling.py                28     28     0%   1-80
mlip_autopipec/training/__init__.py                  4      4     0%   1-5
mlip_autopipec/training/config_gen.py               16     16     0%   1-46
mlip_autopipec/training/dataset.py                 104    104     0%   6-219
mlip_autopipec/training/pacemaker.py                92     92     0%   6-187
mlip_autopipec/training/physics.py                  39     39     0%   6-109
mlip_autopipec/utils/__init__.py                     0      0   100%
mlip_autopipec/utils/ase_utils.py                   42     42     0%   12-120
mlip_autopipec/utils/config_utils.py                 7      7     0%   3-38
mlip_autopipec/utils/dask_utils.py                  12     12     0%   6-43
mlip_autopipec/utils/data_loader.py                 15     15     0%   5-39
mlip_autopipec/utils/resilience.py                  29     29     0%   6-93
mlip_autopipec/utils/workflow_utils.py              32     32     0%   3-53
mlip_autopipec/workflow_manager.py                 106    106     0%   1-191
------------------------------------------------------------------------------
TOTAL                                             3021   2463    18%
=========================== short test summary info ============================
FAILED tests/e2e/test_generator_uat.py::test_uat_2_3_defect_vacancy - assert ...
FAILED tests/e2e/test_generator_uat.py::test_uat_2_4_defect_interstitial - as...
========================= 2 failed, 49 passed in 6.22s =========================
