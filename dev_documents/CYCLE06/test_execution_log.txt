============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
testpaths: tests
plugins: cov-7.0.0, hypothesis-6.151.5
collected 94 items

tests/integration/test_generator_integration.py ..                       [  2%]
tests/integration/test_orchestrator_mock.py ...                          [  5%]
tests/integration/test_otf_loop.py F                                     [  6%]
tests/integration/test_trainer_pacemaker.py ..                           [  8%]
tests/unit/test_config.py ...                                            [ 11%]
tests/unit/test_config_dynamics.py .......                               [ 19%]
tests/unit/test_config_trainer.py ...                                    [ 22%]
tests/unit/test_dataset.py ...                                           [ 25%]
tests/unit/test_dataset_pandas.py ..                                     [ 27%]
tests/unit/test_dataset_streaming.py ..                                  [ 29%]
tests/unit/test_dynamics_eon.py ...                                      [ 32%]
tests/unit/test_dynamics_hybrid.py FF                                    [ 35%]
tests/unit/test_dynamics_lammps.py ....                                  [ 39%]
tests/unit/test_factory.py .....                                         [ 44%]
tests/unit/test_generator_components.py .......                          [ 52%]
tests/unit/test_oracle_embedding.py .....                                [ 57%]
tests/unit/test_oracle_healing.py ......                                 [ 63%]
tests/unit/test_oracle_mock.py .                                         [ 64%]
tests/unit/test_oracle_qe.py .....                                       [ 70%]
tests/unit/test_orchestrator_cycle06.py ...                              [ 73%]
tests/unit/test_report.py ..                                             [ 75%]
tests/unit/test_state.py ...                                             [ 78%]
tests/unit/test_structure.py ............                                [ 91%]
tests/unit/test_trainer_activeset.py ....                                [ 95%]
tests/unit/test_validator_components.py ....                             [100%]

=================================== FAILURES ===================================
___________________________ test_otf_loop_execution ____________________________

mock_state = <MagicMock name='StateManager' id='140567101054784'>
mock_dataset = <MagicMock name='Dataset' id='140567106020096'>
mock_factory = <MagicMock name='ComponentFactory' id='140567101051136'>
mock_config = <GlobalConfig(workdir=/tmp/pytest-of-jules/pytest-39/test_otf_loop_execution0)>
tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-39/test_otf_loop_execution0')

    @patch("mlip_autopipec.core.orchestrator.ComponentFactory")
    @patch("mlip_autopipec.core.orchestrator.Dataset")
    @patch("mlip_autopipec.core.orchestrator.StateManager")
    def test_otf_loop_execution(
        mock_state: MagicMock,
        mock_dataset: MagicMock,
        mock_factory: MagicMock,
        mock_config: GlobalConfig,
        tmp_path: Path
    ) -> None:
        # Setup mocks
        mock_generator = MagicMock()
        mock_oracle = MagicMock()
        mock_trainer = MagicMock() # PacemakerTrainer
        mock_dynamics = MagicMock() # LAMMPSDynamics
        mock_validator = MagicMock()

        mock_factory.get_generator.return_value = mock_generator
        mock_factory.get_oracle.return_value = mock_oracle
        mock_factory.get_trainer.return_value = mock_trainer
        mock_factory.get_dynamics.return_value = mock_dynamics
        mock_factory.get_validator.return_value = mock_validator

        # State Manager
        state_instance = mock_state.return_value
        state_instance.state.current_cycle = 1 # Start at cycle 1 (Dynamics phase)

        # Potential
        mock_config.workdir.mkdir(parents=True, exist_ok=True)
        potential_file = mock_config.workdir / "potential.yace"
        potential_file.touch()

        # Dynamics returns a halted structure
        halted_struct = Structure(
            positions=np.array([[0.0, 0.0, 0.0], [1.0, 0.0, 0.0]]),
            atomic_numbers=np.array([1, 1]),
            cell=np.array([[10.0, 0, 0], [0, 10.0, 0], [0, 0, 10.0]]),
            pbc=np.array([True, True, True]),
            uncertainty=100.0,
            tags={"provenance": "dynamics_halted"}
        )
        # Dynamics explore yields this structure
        mock_dynamics.explore.return_value = iter([halted_struct])

        # Trainer select_active_set mock
        # Should return a subset of candidates
        def mock_select(candidates: list[Structure], limit: int | None = None) -> list[Structure]:
            return candidates[:limit] if limit else candidates

        mock_trainer.select_active_set.side_effect = mock_select
        mock_trainer.train.return_value = Potential(path=potential_file, format="yace")

        # Oracle compute
        def consume_structures(structures: list[Structure]) -> Generator[Structure, None, None]:
            # We must iterate over structures to trigger the generator chain
            # and thus trigger select_active_set inside _enhance_structures
            # Force list realization to ensure generator chain is exhausted
            yield from list(structures)

        mock_oracle.compute.side_effect = consume_structures

        # Run Orchestrator Cycle
        orchestrator = Orchestrator(mock_config)
        orchestrator.current_potential = Potential(path=potential_file, format="yace") # Set initial pot

        try:
            orchestrator._run_cycle()
        except StopIteration:
            pass

        # Verification
        # 1. Dynamics.explore was called
        mock_dynamics.explore.assert_called_once()

        # 2. Trainer.select_active_set was called (proving OTF logic triggered)
        # The consumption of the generator should trigger this.
        # Note: In mock tests, iterating over the dataset might consume elements lazily.
        # We must ensure the consumption happened.
        # The `Dataset.append` iterates over `labeled_structures`, which is `mock_oracle.compute(structures)`.
        # `structures` is `_enhance_structures(raw_structures)`.
        # `raw_structures` is `mock_dynamics.explore`.

        # We asserted mock_dynamics.explore called.
        # The issue might be that `halted_struct` tag check logic in `_enhance_structures`.
        # It checks `provenance`.
        # And we mocked `mock_trainer.select_active_set`.

        # Let's check call count
>       assert mock_trainer.select_active_set.call_count >= 1
E       AssertionError: assert 0 >= 1
E        +  where 0 = <MagicMock name='ComponentFactory.get_trainer().select_active_set' id='140567101253456'>.call_count
E        +    where <MagicMock name='ComponentFactory.get_trainer().select_active_set' id='140567101253456'> = <MagicMock name='ComponentFactory.get_trainer()' id='140567101037248'>.select_active_set

tests/integration/test_otf_loop.py:130: AssertionError
_________________________ test_generate_pair_style_zbl _________________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-39/test_generate_pair_style_zbl0')

    def test_generate_pair_style_zbl(tmp_path: Path) -> None:
        potential_path = tmp_path / "test.yace"
        potential = Potential(path=potential_path, format="yace", species=["Cu", "Au"])
        baseline = PhysicsBaselineConfig(type="zbl")

>       pair_style, pair_coeff = generate_pair_style(potential, baseline)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_dynamics_hybrid.py:13:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src/mlip_autopipec/components/dynamics/hybrid.py:29: in generate_pair_style
    safe_pot_path = validate_safe_path(potential.path, must_exist=True)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

path = PosixPath('/tmp/pytest-of-jules/pytest-39/test_generate_pair_style_zbl0/test.yace')
base_dir = None, must_exist = True

    def validate_safe_path(path: Path, base_dir: Path | None = None, must_exist: bool = False) -> Path:
        """
        Validate that a path is safe to use (no traversal, strict existence check if needed).

        Args:
            path: The path to validate.
            base_dir: Optional base directory to confine the path to.
            must_exist: If True, the path must exist.

        Returns:
            The resolved absolute path.

        Raises:
            ValueError: If path is unsafe or traversal is detected.
            FileNotFoundError: If must_exist is True and path does not exist.
        """
        try:
            # Resolve strictly
            resolved = path.resolve()
        except OSError as e:
            msg = f"Invalid path: {path}"
            raise ValueError(msg) from e

        # Check for null bytes
        if "\0" in str(resolved):
            msg = "Path contains null bytes"
            raise ValueError(msg)

        if base_dir:
            try:
                resolved_base = base_dir.resolve()
                if not resolved.is_relative_to(resolved_base):
                    msg = f"Path {resolved} is outside permitted directory {resolved_base}"
                    raise ValueError(msg)
            except OSError as e:
                msg = f"Invalid base directory: {base_dir}"
                raise ValueError(msg) from e

        if must_exist and not resolved.exists():
            msg = f"Path does not exist: {resolved}"
>           raise FileNotFoundError(msg)
E           FileNotFoundError: Path does not exist: /tmp/pytest-of-jules/pytest-39/test_generate_pair_style_zbl0/test.yace

src/mlip_autopipec/utils/security.py:44: FileNotFoundError
_____________________ test_generate_pair_style_no_baseline _____________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-39/test_generate_pair_style_no_ba0')

    def test_generate_pair_style_no_baseline(tmp_path: Path) -> None:
        potential_path = tmp_path / "test.yace"
        potential = Potential(path=potential_path, format="yace", species=["Cu"])
>       pair_style, pair_coeff = generate_pair_style(potential, None)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/test_dynamics_hybrid.py:46:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src/mlip_autopipec/components/dynamics/hybrid.py:29: in generate_pair_style
    safe_pot_path = validate_safe_path(potential.path, must_exist=True)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

path = PosixPath('/tmp/pytest-of-jules/pytest-39/test_generate_pair_style_no_ba0/test.yace')
base_dir = None, must_exist = True

    def validate_safe_path(path: Path, base_dir: Path | None = None, must_exist: bool = False) -> Path:
        """
        Validate that a path is safe to use (no traversal, strict existence check if needed).

        Args:
            path: The path to validate.
            base_dir: Optional base directory to confine the path to.
            must_exist: If True, the path must exist.

        Returns:
            The resolved absolute path.

        Raises:
            ValueError: If path is unsafe or traversal is detected.
            FileNotFoundError: If must_exist is True and path does not exist.
        """
        try:
            # Resolve strictly
            resolved = path.resolve()
        except OSError as e:
            msg = f"Invalid path: {path}"
            raise ValueError(msg) from e

        # Check for null bytes
        if "\0" in str(resolved):
            msg = "Path contains null bytes"
            raise ValueError(msg)

        if base_dir:
            try:
                resolved_base = base_dir.resolve()
                if not resolved.is_relative_to(resolved_base):
                    msg = f"Path {resolved} is outside permitted directory {resolved_base}"
                    raise ValueError(msg)
            except OSError as e:
                msg = f"Invalid base directory: {base_dir}"
                raise ValueError(msg) from e

        if must_exist and not resolved.exists():
            msg = f"Path does not exist: {resolved}"
>           raise FileNotFoundError(msg)
E           FileNotFoundError: Path does not exist: /tmp/pytest-of-jules/pytest-39/test_generate_pair_style_no_ba0/test.yace

src/mlip_autopipec/utils/security.py:44: FileNotFoundError
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.12-final-0 _______________

Name                                                      Stmts   Miss  Cover   Missing
---------------------------------------------------------------------------------------
src/mlip_autopipec/__init__.py                                0      0   100%
src/mlip_autopipec/components/__init__.py                     0      0   100%
src/mlip_autopipec/components/dynamics/__init__.py            5      0   100%
src/mlip_autopipec/components/dynamics/base.py               18      3    83%   15, 40, 43
src/mlip_autopipec/components/dynamics/eon.py               105     20    81%   53-57, 209-211, 244-245, 268-276, 290, 324-325, 328, 331
src/mlip_autopipec/components/dynamics/hybrid.py             34     21    38%   37-72
src/mlip_autopipec/components/dynamics/lammps.py             59     26    56%   28-54, 68, 110-111, 114, 117
src/mlip_autopipec/components/dynamics/lammps_driver.py      88     34    61%   58-59, 61-62, 70, 129-144, 151, 173-203
src/mlip_autopipec/components/dynamics/mock.py               32      2    94%   75, 78
src/mlip_autopipec/components/dynamics/otf.py                 7      0   100%
src/mlip_autopipec/components/generator/__init__.py           4      0   100%
src/mlip_autopipec/components/generator/adaptive.py          44      7    84%   54-55, 76-77, 97, 103, 106
src/mlip_autopipec/components/generator/base.py              15      3    80%   12, 25, 28
src/mlip_autopipec/components/generator/builder.py           36      2    94%   29, 32
src/mlip_autopipec/components/generator/mock.py              30      6    80%   34-35, 39-40, 57, 60
src/mlip_autopipec/components/generator/policy.py            50      6    88%   19, 45, 86-87, 98, 101
src/mlip_autopipec/components/generator/rattle.py            29      4    86%   18, 21, 53, 56
src/mlip_autopipec/components/oracle/__init__.py              5      0   100%
src/mlip_autopipec/components/oracle/base.py                 15      3    80%   12, 28, 31
src/mlip_autopipec/components/oracle/embedding.py            19      0   100%
src/mlip_autopipec/components/oracle/healing.py              31      3    90%   13, 78, 81
src/mlip_autopipec/components/oracle/mock.py                 26      4    85%   18-19, 40, 43
src/mlip_autopipec/components/oracle/qe.py                   92     47    49%   67-68, 75-83, 104-167
src/mlip_autopipec/components/oracle/vasp.py                 21      8    62%   20-21, 25, 40-42, 45, 48
src/mlip_autopipec/components/trainer/__init__.py             5      0   100%
src/mlip_autopipec/components/trainer/activeset.py           92     35    62%   29, 32, 42-43, 134, 149-211
src/mlip_autopipec/components/trainer/base.py                22      4    82%   19, 47, 50, 53
src/mlip_autopipec/components/trainer/mock.py                17      2    88%   25, 28
src/mlip_autopipec/components/trainer/pacemaker.py          108     42    61%   35, 62-64, 80-82, 96-105, 114, 129, 138, 142, 191-194, 202-234, 237, 240
src/mlip_autopipec/components/validator/__init__.py           4      0   100%
src/mlip_autopipec/components/validator/base.py              15      3    80%   12, 28, 31
src/mlip_autopipec/components/validator/calculator.py        91     72    21%   36-42, 50-126, 129-156, 159-172
src/mlip_autopipec/components/validator/elastic.py           53     43    19%   34-113
src/mlip_autopipec/components/validator/eos.py               44     32    27%   36-82
src/mlip_autopipec/components/validator/mock.py              14      4    71%   13-15, 30, 33
src/mlip_autopipec/components/validator/phonons.py           45     32    29%   37-81
src/mlip_autopipec/components/validator/standard.py          70     14    80%   55-56, 62-65, 70-73, 94-96, 135, 138
src/mlip_autopipec/constants.py                              15      0   100%
src/mlip_autopipec/core/__init__.py                           0      0   100%
src/mlip_autopipec/core/candidate_generator.py               18      0   100%
src/mlip_autopipec/core/dataset.py                          186     57    69%   45-47, 63-67, 70, 75, 82-85, 92-93, 95-97, 103-105, 115-116, 149-150, 160-162, 167, 176, 180, 184-185, 216, 232-243, 258-259, 263, 293-295, 302, 312-314
src/mlip_autopipec/core/orchestrator.py                     130     16    88%   57, 60, 72-73, 143, 156-172, 216
src/mlip_autopipec/core/report.py                            84     10    88%   43-44, 57, 73-74, 147-151
src/mlip_autopipec/core/state.py                             38      6    84%   14, 17, 34-35, 51, 54
src/mlip_autopipec/domain_models/__init__.py                  4      0   100%
src/mlip_autopipec/domain_models/config.py                  210     24    89%   29, 32, 69-70, 103-109, 131, 134, 156, 159, 299, 302, 317, 320, 341-345, 352
src/mlip_autopipec/domain_models/enums.py                    54      3    94%   14, 26, 29
src/mlip_autopipec/domain_models/files.py                    11     11     0%   1-18
src/mlip_autopipec/domain_models/potential.py                15      2    87%   18, 21
src/mlip_autopipec/domain_models/results.py                  20      1    95%   40
src/mlip_autopipec/domain_models/structure.py               229     53    77%   30, 51-52, 90-91, 98-99, 109-110, 117-118, 129-130, 171-172, 219-221, 224-225, 253-255, 258, 261-262, 270-272, 275-276, 279-280, 283-284, 293-295, 308-309, 313-314, 318-322, 345, 348, 363-364, 367-368
src/mlip_autopipec/factory.py                                42      2    95%   102, 105
src/mlip_autopipec/interfaces/__init__.py                     0      0   100%
src/mlip_autopipec/interfaces/base_component.py              14      2    86%   20, 23
src/mlip_autopipec/main.py                                   38     38     0%   1-58
src/mlip_autopipec/utils/__init__.py                          0      0   100%
src/mlip_autopipec/utils/logging.py                          13     13     0%   1-19
src/mlip_autopipec/utils/security.py                         23     13    43%   23-25, 29-30, 33-40
---------------------------------------------------------------------------------------
TOTAL                                                      2489    733    71%
=========================== short test summary info ============================
FAILED tests/integration/test_otf_loop.py::test_otf_loop_execution - Assertio...
FAILED tests/unit/test_dynamics_hybrid.py::test_generate_pair_style_zbl - Fil...
FAILED tests/unit/test_dynamics_hybrid.py::test_generate_pair_style_no_baseline
========================= 3 failed, 91 passed in 8.80s =========================
