============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
testpaths: tests
plugins: cov-7.0.0
collected 151 items

tests/e2e/test_cycle01.py FFFFFF.                                        [  4%]
tests/uat/test_cycle02_full_pipeline.py F                                [  5%]
tests/uat/test_cycle02_structure_gen.py F.F                              [  7%]
tests/uat/test_cycle03_oracle.py .                                       [  7%]
tests/uat/test_cycle06_orchestrator.py F                                 [  8%]
tests/unit/dft/test_inputs.py ....                                       [ 11%]
tests/unit/dft/test_parsers.py ....                                      [ 13%]
tests/unit/dft/test_recovery.py ....                                     [ 16%]
tests/unit/dft/test_runner.py ......                                     [ 20%]
tests/unit/dft/test_security.py ..                                       [ 21%]
tests/unit/generator/test_builder.py ....                                [ 24%]
tests/unit/generator/test_coverage.py FFFF..                             [ 28%]
tests/unit/generator/test_defects.py F                                   [ 29%]
tests/unit/generator/test_schemas.py ......                              [ 33%]
tests/unit/generator/test_sqs.py ..                                      [ 34%]
tests/unit/generator/test_transformations.py ....                        [ 37%]
tests/unit/inference/test_eon_schema.py ...                              [ 39%]
tests/unit/inference/test_eon_wrapper.py ......                          [ 43%]
tests/unit/inference/test_inference_inputs.py .....                      [ 46%]
tests/unit/inference/test_lammps_runner.py ..                            [ 47%]
tests/unit/inference/test_pace_driver.py ..                              [ 49%]
tests/unit/inference/test_parsers.py ....                                [ 51%]
tests/unit/inference/test_runner.py ..                                   [ 52%]
tests/unit/inference/test_schemas.py .....                               [ 56%]
tests/unit/inference/test_writer.py .                                    [ 56%]
tests/unit/orchestration/test_db_manager.py FF                           [ 58%]
tests/unit/orchestration/test_state.py ...                               [ 60%]
tests/unit/orchestration/test_strategies.py ..                           [ 61%]
tests/unit/orchestration/test_workflow.py ..                             [ 62%]
tests/unit/test_atoms.py ....                                            [ 65%]
tests/unit/test_cli_dft.py ....                                          [ 68%]
tests/unit/test_cli_validation.py ...                                    [ 70%]
tests/unit/test_config.py .....                                          [ 73%]
tests/unit/test_database.py .................                            [ 84%]
tests/unit/test_feedback_fixes.py ....                                   [ 87%]
tests/unit/training/test_dataset.py .                                    [ 88%]
tests/unit/training/test_metrics.py .......                              [ 92%]
tests/unit/training/test_pacemaker.py ..                                 [ 94%]
tests/unit/training/test_schemas.py .                                    [ 94%]
tests/unit/utils/test_embedding.py .                                     [ 95%]
tests/unit/validation/test_physics_validators.py .                       [ 96%]
tests/unit/validation/test_schemas.py ......                             [100%]

=================================== FAILURES ===================================
__________________________ test_init_creates_template __________________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-13/test_init_creates_template0')

    def test_init_creates_template(tmp_path):
        with runner.isolated_filesystem(temp_dir=tmp_path):
            result = runner.invoke(app, ["init"])
>           assert result.exit_code == 0
E           assert 2 == 0
E            +  where 2 = <Result SystemExit(2)>.exit_code

tests/e2e/test_cycle01.py:21: AssertionError
___________________________ test_init_existing_file ____________________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-13/test_init_existing_file0')

    def test_init_existing_file(tmp_path):
        with runner.isolated_filesystem(temp_dir=tmp_path):
            # Create dummy file
            Path("input.yaml").touch()
            result = runner.invoke(app, ["init"])
>           assert result.exit_code == 0
E           assert 2 == 0
E            +  where 2 = <Result SystemExit(2)>.exit_code

tests/e2e/test_cycle01.py:36: AssertionError
__________________________ test_validate_valid_config __________________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-13/test_validate_valid_config0')

    def test_validate_valid_config(tmp_path):
        with runner.isolated_filesystem(temp_dir=tmp_path):
            # Create valid config
            runner.invoke(app, ["init"])

            # Override pseudopotential_dir to a valid path for validation
>           with Path("input.yaml").open() as f:
                 ^^^^^^^^^^^^^^^^^^^^^^^^^

tests/e2e/test_cycle01.py:46:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = PosixPath('input.yaml'), mode = 'r', buffering = -1, encoding = 'locale'
errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed to by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       FileNotFoundError: [Errno 2] No such file or directory: 'input.yaml'

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/pathlib.py:1013: FileNotFoundError
_________________________ test_validate_invalid_config _________________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-13/test_validate_invalid_config0')

    def test_validate_invalid_config(tmp_path):
        with runner.isolated_filesystem(temp_dir=tmp_path):
            with Path("bad_config.yaml").open("w") as f:
                f.write("target_system: []\n")  # Invalid type

            result = runner.invoke(app, ["validate", "bad_config.yaml"])
>           assert result.exit_code == 1
E           assert 2 == 1
E            +  where 2 = <Result SystemExit(2)>.exit_code

tests/e2e/test_cycle01.py:68: AssertionError
__________________________ test_validate_missing_file __________________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-13/test_validate_missing_file0')

    def test_validate_missing_file(tmp_path):
        result = runner.invoke(app, ["validate", "non_existent.yaml"])
>       assert result.exit_code == 1
E       assert 2 == 1
E        +  where 2 = <Result SystemExit(2)>.exit_code

tests/e2e/test_cycle01.py:74: AssertionError
_________________________________ test_db_init _________________________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-13/test_db_init0')

    def test_db_init(tmp_path):
        with runner.isolated_filesystem(temp_dir=tmp_path):
            runner.invoke(app, ["init"])

            # Fix path
>           with Path("input.yaml").open() as f:
                 ^^^^^^^^^^^^^^^^^^^^^^^^^

tests/e2e/test_cycle01.py:84:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = PosixPath('input.yaml'), mode = 'r', buffering = -1, encoding = 'locale'
errors = None, newline = None

    def open(self, mode='r', buffering=-1, encoding=None,
             errors=None, newline=None):
        """
        Open the file pointed to by this path and return a file object, as
        the built-in open() function does.
        """
        if "b" not in mode:
            encoding = io.text_encoding(encoding)
>       return io.open(self, mode, buffering, encoding, errors, newline)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       FileNotFoundError: [Errno 2] No such file or directory: 'input.yaml'

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/pathlib.py:1013: FileNotFoundError
_______________________ test_run_cycle_02_full_pipeline ________________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-13/test_run_cycle_02_full_pipelin0')

    def test_run_cycle_02_full_pipeline(tmp_path):
        runner = CliRunner()

        config_content = """
    target_system:
      name: Al
      elements: [Al]
      composition: {Al: 1.0}
      crystal_structure: fcc

    generator_config:
      number_of_structures: 2
      seed: 42
      distortion:
        enabled: true
        n_strain_steps: 1
        n_rattle_steps: 1

    dft:
      command: "echo 'mock'"
      pseudopotential_dir: "."

    training_config:
      cutoff: 4.0
      b_basis_size: 10
      kappa: 0.5
      kappa_f: 1.0
      batch_size: 10
      max_iter: 10

    runtime:
      work_dir: "_work_test"
      database_path: "test.db"
    """

        with runner.isolated_filesystem(temp_dir=tmp_path):
            Path("input.yaml").write_text(config_content)
            # Create dummy UPF file to satisfy validation
            Path("dummy.UPF").touch()

            with patch("mlip_autopipec.training.pacemaker.PacemakerWrapper.train") as mock_train:
                # Mock successful training
                mock_train.return_value = TrainingResult(
                    success=True,
                    potential_path=str(Path("_work_test") / "training" / "output.yace"),
                    metrics=TrainingMetrics(epoch=10, rmse_energy=0.01, rmse_force=0.1),
                )

                result = runner.invoke(app, ["run", "cycle-02", "--config", "input.yaml", "--mock-dft"])

>               assert result.exit_code == 0
E               assert 2 == 0
E                +  where 2 = <Result SystemExit(2)>.exit_code

tests/uat/test_cycle02_full_pipeline.py:60: AssertionError
_____________________ test_scenario_02_01_bulk_generation ______________________

    def test_scenario_02_01_bulk_generation() -> None:
        """
        Scenario 02-01: Bulk Structure Generation
        Generate simple bulk supercells with thermal noise.
        """
        target = TargetSystem(
            name="Al", elements=["Al"], composition={"Al": 1.0}, crystal_structure="fcc"
        )

        # Enable SQS to get supercell, even for pure element
        gen_config = GeneratorConfig(
            sqs=SQSConfig(enabled=True, supercell_size=[2, 2, 2]),
            distortion=DistortionConfig(
                enabled=True,
                rattle_stdev=0.1,
                strain_range=(0.0, 0.0),  # Disable strain to focus on rattle
                n_strain_steps=1,
                n_rattle_steps=5,
            ),
            defects=DefectConfig(enabled=False),
            number_of_structures=5,
            seed=123,
        )

        sys_config = SystemConfig(target_system=target, generator_config=gen_config)
        builder = StructureBuilder(sys_config)

        structures = list(builder.build())

        # We requested 5 structures.
>       assert len(structures) == 5
E       AssertionError: assert 1 == 5
E        +  where 1 = len([Atoms(symbols='Al8', pbc=True, cell=[[0.0, 4.05, 4.05], [4.05, 0.0, 4.05], [4.05, 4.05, 0.0]])])

tests/uat/test_cycle02_structure_gen.py:44: AssertionError
_____________________ test_scenario_02_03_reproducibility ______________________

    def test_scenario_02_03_reproducibility() -> None:
        """
        Scenario 02-03: Reproducibility
        Ensure identical seeds produce identical structures.
        """
        target = TargetSystem(
            name="Al", elements=["Al"], composition={"Al": 1.0}, crystal_structure="fcc"
        )

        gen_config = GeneratorConfig(
            sqs=SQSConfig(enabled=True, supercell_size=[2, 2, 2]),
            distortion=DistortionConfig(enabled=True, rattle_stdev=0.05),
            number_of_structures=5,
            seed=42,
        )

        sys_config = SystemConfig(target_system=target, generator_config=gen_config)

        # Run 1
        builder1 = StructureBuilder(sys_config)
        batch1 = list(builder1.build())

        # Run 2
        builder2 = StructureBuilder(sys_config)
        batch2 = list(builder2.build())

        assert len(batch1) == len(batch2)

        for s1, s2 in zip(batch1, batch2, strict=True):
            np.testing.assert_allclose(s1.positions, s2.positions)
            np.testing.assert_allclose(s1.cell, s2.cell)
>           assert s1.info["uuid"] != s2.info["uuid"]  # UUIDs should be different
                   ^^^^^^^^^^^^^^^
E           KeyError: 'uuid'

tests/uat/test_cycle02_structure_gen.py:115: KeyError
________________________ test_uat_full_cycle_simulation ________________________

uat_config = SystemConfig(minimal=None, target_system=TargetSystem(name='UAT System', elements=['Fe'], composition={'Fe': 1.0}, cry...st=1.4, interstitial_cluster_cutoff=0.1), number_of_structures=10, seed=None), generator=None, explorer=None, dft=None)
tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-13/test_uat_full_cycle_simulation0')

    def test_uat_full_cycle_simulation(uat_config, tmp_path):
        work_dir = uat_config.working_dir
        work_dir.mkdir(parents=True, exist_ok=True)
        (work_dir / "current.yace").touch()
        (tmp_path / "new.yace").touch()

        with DatabaseManager(uat_config.db_path) as db:
            atoms = Atoms("Fe", positions=[[0, 0, 0]], cell=[2.5, 2.5, 2.5], pbc=True)
            db.add_structure(atoms, {"status": "training"})
            assert db.count() == 1
            assert db.count(selection="status=training") == 1

        with (
            patch("mlip_autopipec.orchestration.phases.dft.QERunner"),
            patch("mlip_autopipec.orchestration.phases.inference.LammpsRunner") as MockLammpsRunner,
            patch(
                "mlip_autopipec.orchestration.phases.training.PacemakerWrapper"
            ) as MockPacemakerWrapper,
            patch(
                "mlip_autopipec.orchestration.phases.selection.PacemakerWrapper"
            ) as MockSelectionPacemaker,
            patch("mlip_autopipec.inference.processing.EmbeddingExtractor") as MockExtractor,
            patch("mlip_autopipec.inference.processing.read") as mock_ase_read,
            patch("mlip_autopipec.orchestration.phases.training.DatasetBuilder"),
>           patch("mlip_autopipec.orchestration.workflow.TaskQueue") as MockTaskQueue,
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            patch("mlip_autopipec.orchestration.workflow.get_dask_client"),
        ):

tests/uat/test_cycle06_orchestrator.py:69:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x7f36d1e85070>

    def get_original(self):
        target = self.getter()
        name = self.attribute

        original = DEFAULT
        local = False

        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True

        if name in _builtins and isinstance(target, ModuleType):
            self.create = True

        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'mlip_autopipec.orchestration.workflow' from '/app/src/mlip_autopipec/orchestration/workflow.py'> does not have the attribute 'TaskQueue'

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1437: AttributeError
_______________________ test_builder_molecule_generation _______________________

    def test_builder_molecule_generation() -> None:
        target = TargetSystem(
            name="molecule_H2O",
            elements=["H", "O"],
            composition={"H": 2 / 3, "O": 1 / 3},
        )

        config = SystemConfig(target_system=target)
        builder = StructureBuilder(config)

        # Mock ase.build.molecule to return a fake molecule
>       with patch("mlip_autopipec.generator.builder.molecule") as mock_mol:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/generator/test_coverage.py:28:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x7f36d1e045f0>

    def get_original(self):
        target = self.getter()
        name = self.attribute

        original = DEFAULT
        local = False

        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True

        if name in _builtins and isinstance(target, ModuleType):
            self.create = True

        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'mlip_autopipec.generator.builder' from '/app/src/mlip_autopipec/generator/builder.py'> does not have the attribute 'molecule'

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1437: AttributeError
________________________ test_builder_molecule_failure _________________________

    def test_builder_molecule_failure() -> None:
        target = TargetSystem(name="molecule_Invalid", elements=["H"], composition={"H": 1.0})

        config = SystemConfig(target_system=target)
        builder = StructureBuilder(config)

>       with patch("mlip_autopipec.generator.builder.molecule", side_effect=Exception("Mol fail")):
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/generator/test_coverage.py:43:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x7f36d1e87710>

    def get_original(self):
        target = self.getter()
        name = self.attribute

        original = DEFAULT
        local = False

        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True

        if name in _builtins and isinstance(target, ModuleType):
            self.create = True

        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'mlip_autopipec.generator.builder' from '/app/src/mlip_autopipec/generator/builder.py'> does not have the attribute 'molecule'

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1437: AttributeError
__________________________ test_builder_bulk_fallback __________________________

name = 'Al', args = ('fcc',), kwargs = {}, msg = 'Bulk fail'

    def bulk_side_effect(name, *args, **kwargs):
        if name == "Al":
            msg = "Bulk fail"
>           raise Exception(msg)
E           Exception: Bulk fail

tests/unit/generator/test_coverage.py:59: Exception

During handling of the above exception, another exception occurred:

    def test_builder_bulk_fallback() -> None:
        target = TargetSystem(name="Al", elements=["Al"], composition={"Al": 1.0})
        # Disable SQS to avoid overwriting the fallback element
        gen_config = GeneratorConfig(sqs={"enabled": False})
        config = SystemConfig(target_system=target, generator_config=gen_config)
        builder = StructureBuilder(config)

        def bulk_side_effect(name, *args, **kwargs):
            if name == "Al":
                msg = "Bulk fail"
                raise Exception(msg)
            return Atoms("Fe", positions=[[0, 0, 0]], cell=[2, 2, 2], pbc=True)

        with patch("mlip_autopipec.generator.builder.bulk", side_effect=bulk_side_effect):
            # Should fallback to Fe
>           structures = list(builder.build())
                         ^^^^^^^^^^^^^^^^^^^^^

tests/unit/generator/test_coverage.py:64:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src/mlip_autopipec/generator/builder.py:41: in build
    base_atoms = bulk(primary, "fcc", a=4.05)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1139: in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1143: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1204: in _execute_mock_call
    result = effect(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

name = 'Al', args = ('fcc',), kwargs = {'a': 4.05}, msg = 'Bulk fail'

    def bulk_side_effect(name, *args, **kwargs):
        if name == "Al":
            msg = "Bulk fail"
>           raise Exception(msg)
E           Exception: Bulk fail

tests/unit/generator/test_coverage.py:59: Exception
________________________ test_builder_critical_failure _________________________

    def test_builder_critical_failure() -> None:
        # Mock _generate_base to raise generic exception
        target = TargetSystem(name="Al", elements=["Al"], composition={"Al": 1.0})
        config = SystemConfig(target_system=target)
        builder = StructureBuilder(config)

>       with patch.object(builder, "_generate_base", side_effect=Exception("Critical")):
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/generator/test_coverage.py:75:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x7f36d1e8cb60>

    def get_original(self):
        target = self.getter()
        name = self.attribute

        original = DEFAULT
        local = False

        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True

        if name in _builtins and isinstance(target, ModuleType):
            self.create = True

        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <mlip_autopipec.generator.builder.StructureBuilder object at 0x7f36d1e8fb90> does not have the attribute '_generate_base'

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1437: AttributeError
_______________________ test_defect_strategy_validation ________________________

    def test_defect_strategy_validation():
        config = DefectConfig(enabled=True, vacancies=True)
        strategy = DefectStrategy(config)

        with pytest.raises(TypeError):
            strategy.apply("not_atoms")  # type: ignore

        atoms = Atoms("Al", positions=[[0, 0, 0]], cell=[4, 4, 4], pbc=True)
>       results = strategy.apply(atoms)
                  ^^^^^^^^^^^^^^^^^^^^^

tests/unit/generator/test_defects.py:16:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <mlip_autopipec.generator.defects.DefectStrategy object at 0x7f36d1e87650>
structures = Atoms(symbols='Al', pbc=True, cell=[4.0, 4.0, 4.0])
primary_element = None

    def apply(self, structures: list[Atoms], primary_element: str | None = None) -> list[Atoms]:
        """
        Applies defects to a list of structures based on configuration.

        Args:
            structures: List of input atomic structures.
            primary_element: The primary element symbol, used for interstitial fallback.

        Returns:
            list[Atoms]: A list containing the original structures and the newly generated defect structures.
        """
        if not self.config.enabled:
            return structures

        # Validate input structures
        for s in structures:
            if not isinstance(s, Atoms):
                msg = f"Input structure is not an Atoms object: {type(s)}"
>               raise TypeError(msg)
E               TypeError: Input structure is not an Atoms object: <class 'ase.atom.Atom'>

src/mlip_autopipec/generator/defects.py:52: TypeError
________________________ test_select_entries_generator _________________________

db_manager = <mlip_autopipec.orchestration.database.DatabaseManager object at 0x7f36d1cf2210>

    def test_select_entries_generator(db_manager: DatabaseManager) -> None:
        # Mock connection and select
        mock_conn = MagicMock()
        # Create fake rows
        row1 = MagicMock()
        row1.id = 1
        row1.toatoms.return_value = Atoms("H")
        row1.key_value_pairs = {}
        row1.data = {}

        row2 = MagicMock()
        row2.id = 2
        row2.toatoms.return_value = Atoms("He")
        row2.key_value_pairs = {}
        row2.data = {}

        # select returns generator of rows
        mock_conn.select.return_value = iter([row1, row2])

>       with patch.object(db_manager, "connector") as mock_connector:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/unit/orchestration/test_db_manager.py:35:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x7f36d1d5dd30>

    def get_original(self):
        target = self.getter()
        name = self.attribute

        original = DEFAULT
        local = False

        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True

        if name in _builtins and isinstance(target, ModuleType):
            self.create = True

        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <mlip_autopipec.orchestration.database.DatabaseManager object at 0x7f36d1cf2210> does not have the attribute 'connector'

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1437: AttributeError
_____________________ test_add_structure_validation_error ______________________

self = <mlip_autopipec.orchestration.database.DatabaseManager object at 0x7f36d1d72a20>
atoms = Atoms(symbols='H', pbc=False), metadata = {}

    def add_structure(self, atoms: Atoms, metadata: dict[str, Any] | None = None) -> int:
        metadata = metadata or {}
        if self._connection is None:
             msg = "Database not connected"
             raise DatabaseError(msg)
        try:
>           self._validate_atoms(atoms)

src/mlip_autopipec/orchestration/database.py:77:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <mlip_autopipec.orchestration.database.DatabaseManager object at 0x7f36d1d72a20>
atoms = Atoms(symbols='H', pbc=False)

    def _validate_atoms(self, atoms: Atoms) -> None:
        """Validates Atoms object integrity before insertion."""
        if not isinstance(atoms, Atoms):
            msg = "Input must be an ase.Atoms object"
            raise TypeError(msg)

        positions = atoms.get_positions()
        if np.any(np.isnan(positions)) or np.any(np.isinf(positions)):
            msg = "Atoms object contains NaN or Inf in positions."
>           raise ValueError(msg)
E           ValueError: Atoms object contains NaN or Inf in positions.

src/mlip_autopipec/orchestration/database.py:63: ValueError

The above exception was the direct cause of the following exception:

db_manager = <mlip_autopipec.orchestration.database.DatabaseManager object at 0x7f36d1d72a20>

    def test_add_structure_validation_error(db_manager: DatabaseManager) -> None:
        atoms = Atoms("H")
        atoms.positions[0] = [float("nan"), 0, 0]

        with pytest.raises(DatabaseError, match="Invalid Atoms object"):
>           db_manager.add_structure(atoms, {})

tests/unit/orchestration/test_db_manager.py:54:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <mlip_autopipec.orchestration.database.DatabaseManager object at 0x7f36d1d72a20>
atoms = Atoms(symbols='H', pbc=False), metadata = {}

    def add_structure(self, atoms: Atoms, metadata: dict[str, Any] | None = None) -> int:
        metadata = metadata or {}
        if self._connection is None:
             msg = "Database not connected"
             raise DatabaseError(msg)
        try:
            self._validate_atoms(atoms)
            with self._lock:
                row_id = self._connection.write(atoms, **metadata)
            return row_id
        except Exception as e:
            logger.exception(f"Failed to add structure: {e}")
            msg = f"Failed to add structure: {e}"
>           raise DatabaseError(msg) from e
E           mlip_autopipec.exceptions.DatabaseError: Failed to add structure: Atoms object contains NaN or Inf in positions.

src/mlip_autopipec/orchestration/database.py:84: DatabaseError

During handling of the above exception, another exception occurred:

db_manager = <mlip_autopipec.orchestration.database.DatabaseManager object at 0x7f36d1d72a20>

    def test_add_structure_validation_error(db_manager: DatabaseManager) -> None:
        atoms = Atoms("H")
        atoms.positions[0] = [float("nan"), 0, 0]

>       with pytest.raises(DatabaseError, match="Invalid Atoms object"):
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AssertionError: Regex pattern did not match.
E         Expected regex: 'Invalid Atoms object'
E         Actual message: 'Failed to add structure: Atoms object contains NaN or Inf in positions.'

tests/unit/orchestration/test_db_manager.py:53: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    mlip_autopipec.orchestration.database:database.py:82 Failed to add structure: Atoms object contains NaN or Inf in positions.
Traceback (most recent call last):
  File "/app/src/mlip_autopipec/orchestration/database.py", line 77, in add_structure
    self._validate_atoms(atoms)
  File "/app/src/mlip_autopipec/orchestration/database.py", line 63, in _validate_atoms
    raise ValueError(msg)
ValueError: Atoms object contains NaN or Inf in positions.
=============================== warnings summary ===============================
tests/uat/test_cycle02_structure_gen.py::test_scenario_02_02_defect_introduction
  /app/.venv/lib/python3.12/site-packages/spglib/spg.py:438: DeprecationWarning: Set OLD_ERROR_HANDLING to false and catch the errors directly.
    _set_no_error(_throw)

tests/uat/test_cycle02_structure_gen.py::test_scenario_02_02_defect_introduction
  /app/src/mlip_autopipec/generator/defects.py:109: DeprecationWarning: dict interface is deprecated. Use attribute interface instead
    equivalent_atoms = dataset["equivalent_atoms"]

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.12-final-0 _______________

Name                                                     Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------------------
src/mlip_autopipec/__init__.py                               4      0   100%
src/mlip_autopipec/app.py                                   50     19    62%   54-73, 95-97, 124-128, 131
src/mlip_autopipec/config/__init__.py                       12      0   100%
src/mlip_autopipec/config/factory.py                        37     37     0%   1-62
src/mlip_autopipec/config/loaders/__init__.py                2      0   100%
src/mlip_autopipec/config/loaders/yaml_loader.py            58     44    24%   24-45, 53-65, 73-95
src/mlip_autopipec/config/models.py                         48      0   100%
src/mlip_autopipec/config/schemas/common.py                 18      5    72%   8-11, 30
src/mlip_autopipec/config/schemas/core.py                   42      8    81%   29-30, 35-36, 40-41, 47-48
src/mlip_autopipec/config/schemas/dft.py                    42      7    83%   41-42, 59-63
src/mlip_autopipec/config/schemas/exploration.py             5      0   100%
src/mlip_autopipec/config/schemas/generator.py              28      0   100%
src/mlip_autopipec/config/schemas/inference.py              47      2    96%   89-90
src/mlip_autopipec/config/schemas/monitoring.py             12      0   100%
src/mlip_autopipec/config/schemas/surrogate.py              23      0   100%
src/mlip_autopipec/config/schemas/training.py               42      6    86%   43-44, 46-47, 57-58
src/mlip_autopipec/config/schemas/validation.py             20      0   100%
src/mlip_autopipec/config/schemas/workflow.py                6      0   100%
src/mlip_autopipec/core/__init__.py                          0      0   100%
src/mlip_autopipec/core/services.py                         13      2    85%   31-32
src/mlip_autopipec/core/workspace.py                        13     13     0%   1-25
src/mlip_autopipec/dft/__init__.py                           0      0   100%
src/mlip_autopipec/dft/constants.py                          3      0   100%
src/mlip_autopipec/dft/inputs.py                            70      8    89%   35, 83-87, 126, 136, 161
src/mlip_autopipec/dft/parsers.py                           41      4    90%   78-79, 100-101
src/mlip_autopipec/dft/recovery.py                          47     14    70%   39-46, 88-100
src/mlip_autopipec/dft/runner.py                           124     41    67%   50-51, 64-65, 88-89, 104-128, 151-152, 154-156, 160, 167-168, 185-186, 188, 204, 232-236, 253, 274-276
src/mlip_autopipec/domain_models/__init__.py                 5      0   100%
src/mlip_autopipec/domain_models/atoms.py                   36      9    75%   29-30, 41-45, 50-51, 62
src/mlip_autopipec/domain_models/candidate.py               10     10     0%   1-19
src/mlip_autopipec/domain_models/dft_models.py              63     11    83%   57-58, 65, 75-83
src/mlip_autopipec/domain_models/inference_models.py        30      9    70%   28-37
src/mlip_autopipec/domain_models/state.py                   14      0   100%
src/mlip_autopipec/domain_models/structure_enums.py          9      9     0%   1-11
src/mlip_autopipec/domain_models/training_data.py           68     41    40%   29-35, 43-64, 69-82, 96-102
src/mlip_autopipec/domain_models/validation.py              15      0   100%
src/mlip_autopipec/exceptions.py                            25      8    68%   43-48, 51-52, 65
src/mlip_autopipec/generator/__init__.py                     5      0   100%
src/mlip_autopipec/generator/builder.py                     81      8    90%   87-88, 106-107, 112-113, 119-120
src/mlip_autopipec/generator/defects.py                    104     54    48%   46, 59, 67-69, 88-89, 94, 107, 124-136, 154-220
src/mlip_autopipec/generator/distortions.py                 43     43     0%   1-82
src/mlip_autopipec/generator/sqs.py                         44      9    80%   55, 78-83, 95-98
src/mlip_autopipec/generator/transformations.py             48      5    90%   47-49, 51, 94
src/mlip_autopipec/inference/__init__.py                     8      0   100%
src/mlip_autopipec/inference/analysis.py                    44     39    11%   22, 34-88
src/mlip_autopipec/inference/drivers/pace_driver.py         48     28    42%   11-17, 48-82, 86
src/mlip_autopipec/inference/eon.py                         72     10    86%   66-67, 115-117, 120-121, 161-163
src/mlip_autopipec/inference/inputs.py                      39      3    92%   60-62
src/mlip_autopipec/inference/interfaces.py                   5      0   100%
src/mlip_autopipec/inference/masking.py                     36     32    11%   23-77
src/mlip_autopipec/inference/parsers.py                     50     11    78%   36, 65-72, 87-89
src/mlip_autopipec/inference/processing.py                  40     28    30%   22-24, 39-81
src/mlip_autopipec/inference/runner.py                      71     16    77%   69-77, 91, 102-104, 127-128, 134-135
src/mlip_autopipec/inference/uq.py                          23     17    26%   9, 16-38
src/mlip_autopipec/inference/writer.py                      21      0   100%
src/mlip_autopipec/modules/__init__.py                       0      0   100%
src/mlip_autopipec/modules/cli_handlers/handlers.py        214    158    26%   27-67, 73-181, 185-187, 191-219, 223-236, 240-272, 276-281, 285-296, 303-311, 322-323, 329-331, 334-335, 339
src/mlip_autopipec/modules/training_orchestrator.py         22     12    45%   43-45, 60-73
src/mlip_autopipec/monitoring/__init__.py                    0      0   100%
src/mlip_autopipec/monitoring/dashboard.py                  64     64     0%   1-118
src/mlip_autopipec/orchestration/__init__.py                 7      0   100%
src/mlip_autopipec/orchestration/dashboard.py               57     37    35%   44-47, 58-68, 80-116, 129-131
src/mlip_autopipec/orchestration/database.py               185     45    76%   37, 48, 57-58, 74-75, 88-89, 99-100, 111-112, 126-127, 136-138, 147-148, 154-157, 168-169, 175-178, 183-184, 193-194, 225-226, 231-234, 238-239, 242-245
src/mlip_autopipec/orchestration/interfaces.py              10     10     0%   1-30
src/mlip_autopipec/orchestration/phase_executor.py          23     23     0%   1-47
src/mlip_autopipec/orchestration/phases/base.py             10      4    60%   14-17
src/mlip_autopipec/orchestration/phases/dft.py              36     29    19%   13-62
src/mlip_autopipec/orchestration/phases/exploration.py      34     22    35%   17-22, 28-55
src/mlip_autopipec/orchestration/phases/inference.py        54     43    20%   24-90
src/mlip_autopipec/orchestration/phases/selection.py        38     30    21%   17-69
src/mlip_autopipec/orchestration/phases/training.py         39     31    21%   14-58
src/mlip_autopipec/orchestration/strategies.py              27      1    96%   50
src/mlip_autopipec/orchestration/task_queue.py              77     62    19%   30-52, 69-78, 97-126, 141-144, 150-154
src/mlip_autopipec/orchestration/workflow.py                93     55    41%   41-42, 46-47, 51-57, 80-151
src/mlip_autopipec/surrogate/__init__.py                     5      0   100%
src/mlip_autopipec/surrogate/candidate_manager.py           19     11    42%   12, 15-28
src/mlip_autopipec/surrogate/descriptors.py                 31     31     0%   1-85
src/mlip_autopipec/surrogate/mace_client.py                 66     66     0%   1-150
src/mlip_autopipec/surrogate/mace_wrapper.py                57     50    12%   11-13, 19-39, 45-67, 73-112
src/mlip_autopipec/surrogate/model_interface.py              8      0   100%
src/mlip_autopipec/surrogate/pipeline.py                   106     90    15%   22-28, 38-59, 63-68, 71-72, 77-127, 132-175
src/mlip_autopipec/surrogate/sampling.py                    19     14    26%   7, 19-45
src/mlip_autopipec/training/__init__.py                      4      0   100%
src/mlip_autopipec/training/config_gen.py                   17      9    47%   14-15, 33-47
src/mlip_autopipec/training/dataset.py                      51     10    80%   38, 41, 59, 61, 88-90, 93-94, 97
src/mlip_autopipec/training/metrics.py                      41      3    93%   40-42
src/mlip_autopipec/training/pacemaker.py                    60     24    60%   56-57, 71-78, 83-84, 88-89, 96-116
src/mlip_autopipec/training/physics.py                      39     28    28%   43-112
src/mlip_autopipec/utils/__init__.py                         0      0   100%
src/mlip_autopipec/utils/ase_utils.py                       44     44     0%   12-122
src/mlip_autopipec/utils/config_utils.py                    33     22    33%   20, 25-27, 40-60
src/mlip_autopipec/utils/dask_utils.py                      13     13     0%   6-48
src/mlip_autopipec/utils/data_loader.py                     15     15     0%   5-39
src/mlip_autopipec/utils/embedding.py                       13      4    69%   19-22
src/mlip_autopipec/utils/logging.py                         11     11     0%   5-31
src/mlip_autopipec/utils/resilience.py                      30     30     0%   6-94
src/mlip_autopipec/utils/workflow_utils.py                  32     32     0%   3-53
src/mlip_autopipec/validation/__init__.py                    0      0   100%
src/mlip_autopipec/validation/elasticity.py                 18      2    89%   41-42
src/mlip_autopipec/validation/eos.py                        19     19     0%   1-46
src/mlip_autopipec/validation/phonon.py                     18     18     0%   1-41
src/mlip_autopipec/validation/runner.py                     27     27     0%   1-54
--------------------------------------------------------------------------------------
TOTAL                                                     3650   1809    50%
=========================== short test summary info ============================
FAILED tests/e2e/test_cycle01.py::test_init_creates_template - assert 2 == 0
FAILED tests/e2e/test_cycle01.py::test_init_existing_file - assert 2 == 0
FAILED tests/e2e/test_cycle01.py::test_validate_valid_config - FileNotFoundEr...
FAILED tests/e2e/test_cycle01.py::test_validate_invalid_config - assert 2 == 1
FAILED tests/e2e/test_cycle01.py::test_validate_missing_file - assert 2 == 1
FAILED tests/e2e/test_cycle01.py::test_db_init - FileNotFoundError: [Errno 2]...
FAILED tests/uat/test_cycle02_full_pipeline.py::test_run_cycle_02_full_pipeline
FAILED tests/uat/test_cycle02_structure_gen.py::test_scenario_02_01_bulk_generation
FAILED tests/uat/test_cycle02_structure_gen.py::test_scenario_02_03_reproducibility
FAILED tests/uat/test_cycle06_orchestrator.py::test_uat_full_cycle_simulation
FAILED tests/unit/generator/test_coverage.py::test_builder_molecule_generation
FAILED tests/unit/generator/test_coverage.py::test_builder_molecule_failure
FAILED tests/unit/generator/test_coverage.py::test_builder_bulk_fallback - Ex...
FAILED tests/unit/generator/test_coverage.py::test_builder_critical_failure
FAILED tests/unit/generator/test_defects.py::test_defect_strategy_validation
FAILED tests/unit/orchestration/test_db_manager.py::test_select_entries_generator
FAILED tests/unit/orchestration/test_db_manager.py::test_add_structure_validation_error
================= 17 failed, 134 passed, 2 warnings in 11.34s ==================
