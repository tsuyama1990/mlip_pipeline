============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
plugins: mock-3.15.1, cov-7.0.0
collected 12 items

tests/orchestration/test_manager.py ...F                                 [ 33%]
tests/integration/test_orchestration_integration.py F                    [ 41%]
tests/uat/cycle_08_uat.py FF                                             [ 58%]
tests/core/test_database_manager.py .FF..                                [100%]

=================================== FAILURES ===================================
_______________________ test_manager_run_max_generations _______________________

mock_dependencies = None
valid_system_config = SystemConfig(minimal=MinimalConfig(project_name='test_project', target_system=TargetSystem(name='Al', structure_type='...training_config=None, inference_config=None, generator_config=None, generator=None, explorer=None, dask=None, dft=None)

    def test_manager_run_max_generations(mock_dependencies: None, valid_system_config: SystemConfig) -> None:
        valid_system_config.working_dir.mkdir(parents=True, exist_ok=True)
>       orch_config = OrchestratorConfig(max_generations=0) # Should stop immediately
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestratorConfig
E       max_generations
E         Input should be greater than or equal to 1 [type=greater_than_equal, input_value=0, input_type=int]
E           For further information visit https://errors.pydantic.dev/2.12/v/greater_than_equal

tests/orchestration/test_manager.py:90: ValidationError
___________________________ test_grand_mock_workflow ___________________________

mocker = <pytest_mock.plugin.MockerFixture object at 0x7f0b7142f260>
valid_system_config = SystemConfig(minimal=MinimalConfig(project_name='test_project', target_system=TargetSystem(name='Al', structure_type='...), lammps_executable=None, elements=['Al']), generator_config=None, generator=None, explorer=None, dask=None, dft=None)

    def test_grand_mock_workflow(mocker: MockerFixture, valid_system_config: SystemConfig) -> None:
        # 1. Mock External Components
        mock_builder = mocker.patch("mlip_autopipec.orchestration.manager.StructureBuilder")
        mock_surrogate = mocker.patch("mlip_autopipec.orchestration.manager.SurrogatePipeline")
        # We patch QERunner and LammpsRunner but don't strictly need the return object variable if not asserting methods on it directly
        mocker.patch("mlip_autopipec.orchestration.manager.QERunner")
        mock_pacemaker = mocker.patch("mlip_autopipec.orchestration.manager.PacemakerWrapper")
>       mocker.patch("mlip_autopipec.orchestration.manager.LammpsRunner")

tests/integration/test_orchestration_integration.py:53:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/pytest_mock/plugin.py:448: in __call__
    return self._start_patch(
.venv/lib/python3.12/site-packages/pytest_mock/plugin.py:266: in _start_patch
    mocked: MockType = p.start()
                       ^^^^^^^^^
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x7f0b716961e0>

    def get_original(self):
        target = self.getter()
        name = self.attribute

        original = DEFAULT
        local = False

        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True

        if name in _builtins and isinstance(target, ModuleType):
            self.create = True

        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'mlip_autopipec.orchestration.manager' from '/app/mlip_autopipec/orchestration/manager.py'> does not have the attribute 'LammpsRunner'

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1437: AttributeError
___________________ test_uat_08_01_end_to_end_autonomous_run ___________________

mocker = <pytest_mock.plugin.MockerFixture object at 0x7f0b7142df40>
tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-11/test_uat_08_01_end_to_end_auto0')

    def test_uat_08_01_end_to_end_autonomous_run(mocker: MockerFixture, tmp_path: Path) -> None:
        """
        UAT-08-01: Verify that the system can perform a complete "Zero-Human" run.
        """
        # Mock Physics Engines
        mocker.patch("mlip_autopipec.orchestration.manager.StructureBuilder")
        mocker.patch("mlip_autopipec.orchestration.manager.SurrogatePipeline")
        mocker.patch("mlip_autopipec.orchestration.manager.QERunner")
        mocker.patch("mlip_autopipec.orchestration.manager.PacemakerWrapper")
        # mocker.patch("mlip_autopipec.orchestration.manager.LammpsRunner") # Not imported in current manager refactor?
        # Let's check imports in manager.py. It imports LammpsRunner.
>       mocker.patch("mlip_autopipec.orchestration.manager.LammpsRunner")

tests/uat/cycle_08_uat.py:28:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/pytest_mock/plugin.py:448: in __call__
    return self._start_patch(
.venv/lib/python3.12/site-packages/pytest_mock/plugin.py:266: in _start_patch
    mocked: MockType = p.start()
                       ^^^^^^^^^
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x7f0b7188a600>

    def get_original(self):
        target = self.getter()
        name = self.attribute

        original = DEFAULT
        local = False

        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True

        if name in _builtins and isinstance(target, ModuleType):
            self.create = True

        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'mlip_autopipec.orchestration.manager' from '/app/mlip_autopipec/orchestration/manager.py'> does not have the attribute 'LammpsRunner'

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1437: AttributeError
_______________________ test_uat_08_02_checkpoint_resume _______________________

mocker = <pytest_mock.plugin.MockerFixture object at 0x7f0b71420ef0>
tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-11/test_uat_08_02_checkpoint_resu0')

    def test_uat_08_02_checkpoint_resume(mocker: MockerFixture, tmp_path: Path) -> None:
        """
        UAT-08-02: Verify Checkpoint & Resume.
        """
        # Mocks
        mocker.patch("mlip_autopipec.orchestration.manager.StructureBuilder")
        mocker.patch("mlip_autopipec.orchestration.manager.SurrogatePipeline")
        mocker.patch("mlip_autopipec.orchestration.manager.QERunner")
        mocker.patch("mlip_autopipec.orchestration.manager.PacemakerWrapper")
>       mocker.patch("mlip_autopipec.orchestration.manager.LammpsRunner")

tests/uat/cycle_08_uat.py:107:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/pytest_mock/plugin.py:448: in __call__
    return self._start_patch(
.venv/lib/python3.12/site-packages/pytest_mock/plugin.py:266: in _start_patch
    mocked: MockType = p.start()
                       ^^^^^^^^^
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1624: in start
    result = self.__enter__()
             ^^^^^^^^^^^^^^^^
/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x7f0b713ecbf0>

    def get_original(self):
        target = self.getter()
        name = self.attribute

        original = DEFAULT
        local = False

        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True

        if name in _builtins and isinstance(target, ModuleType):
            self.create = True

        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'mlip_autopipec.orchestration.manager' from '/app/mlip_autopipec/orchestration/manager.py'> does not have the attribute 'LammpsRunner'

/home/jules/.pyenv/versions/3.12.12/lib/python3.12/unittest/mock.py:1437: AttributeError
___________________ test_db_manager_save_retrieve_candidate ____________________

mock_ase_db = <mlip_autopipec.core.database.DatabaseManager object at 0x7f0b71413080>

    def test_db_manager_save_retrieve_candidate(mock_ase_db):
        atoms = Atoms("H2", positions=[[0, 0, 0], [0, 0, 0.74]])
        metadata = {"status": "pending", "generation": 0}

        mock_ase_db.save_candidate(atoms, metadata)

        retrieved = mock_ase_db.get_atoms("status=pending")
>       assert len(retrieved) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests/core/test_database_manager.py:30: AssertionError
____________________________ test_db_manager_count _____________________________

mock_ase_db = <mlip_autopipec.core.database.DatabaseManager object at 0x7f0b71413ef0>

    def test_db_manager_count(mock_ase_db):
        atoms = Atoms("H")
        mock_ase_db.save_candidate(atoms, {"status": "pending"})
        mock_ase_db.save_candidate(atoms, {"status": "training"})

>       assert mock_ase_db.count() == 2
E       assert 0 == 2
E        +  where 0 = count()
E        +    where count = <mlip_autopipec.core.database.DatabaseManager object at 0x7f0b71413ef0>.count

tests/core/test_database_manager.py:40: AssertionError
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.12-final-0 _______________

Name                                             Stmts   Miss  Cover   Missing
------------------------------------------------------------------------------
mlip_autopipec/__init__.py                           0      0   100%
mlip_autopipec/app.py                               36     36     0%   5-63
mlip_autopipec/config/__init__.py                    2      0   100%
mlip_autopipec/config/factory.py                    37     37     0%   1-62
mlip_autopipec/config/models.py                      8      0   100%
mlip_autopipec/config/schemas/common.py             46      9    80%   19, 23-24, 29-30, 50-51, 57-58
mlip_autopipec/config/schemas/dft.py                70     20    71%   27-32, 46-51, 68-70, 101-107
mlip_autopipec/config/schemas/exploration.py        51      4    92%   35-39
mlip_autopipec/config/schemas/generator.py          37      6    84%   14-19
mlip_autopipec/config/schemas/inference.py          49     10    80%   44-46, 51-57, 63, 101
mlip_autopipec/config/schemas/monitoring.py         12      0   100%
mlip_autopipec/config/schemas/surrogate.py          37      6    84%   59-65
mlip_autopipec/config/schemas/system.py             66      4    94%   73-76
mlip_autopipec/config/schemas/training.py           80     13    84%   57-60, 91-100
mlip_autopipec/core/__init__.py                      0      0   100%
mlip_autopipec/core/database.py                    115     68    41%   58-59, 66-80, 86-87, 100-109, 126-127, 129-131, 142-168, 176-197, 209-212, 228, 230-232
mlip_autopipec/core/logging.py                      18     18     0%   5-47
mlip_autopipec/core/workspace.py                    13     13     0%   1-25
mlip_autopipec/data/__init__.py                      0      0   100%
mlip_autopipec/data/database.py                     23     23     0%   7-73
mlip_autopipec/data_models/__init__.py               4      0   100%
mlip_autopipec/data_models/dft_models.py            35      8    77%   33-35, 41-45
mlip_autopipec/data_models/inference_models.py      18      7    61%   26-33
mlip_autopipec/data_models/training_data.py         53     25    53%   30-32, 40-49, 54-65, 79-84
mlip_autopipec/dft/__init__.py                       0      0   100%
mlip_autopipec/dft/constants.py                      3      0   100%
mlip_autopipec/dft/inputs.py                        57     44    23%   28-121, 129-135, 142-150, 157-166
mlip_autopipec/dft/parsers.py                       21     14    33%   26, 51-83
mlip_autopipec/dft/recovery.py                      30     21    30%   33-40, 49-81
mlip_autopipec/dft/runner.py                        79     60    24%   27, 33-140, 146-161, 169-170
mlip_autopipec/exceptions.py                        25     13    48%   43-48, 51-52, 59-60, 63-66
mlip_autopipec/generator/__init__.py                 5      0   100%
mlip_autopipec/generator/alloy.py                  101     87    14%   30, 52-103, 122-139, 158-169, 190-237
mlip_autopipec/generator/builder.py                 75     60    20%   29-38, 55-92, 96-121, 125-140
mlip_autopipec/generator/defect.py                  66     54    18%   33-52, 71-106, 124-125, 138-157
mlip_autopipec/generator/molecule.py                54     42    22%   27, 49-120
mlip_autopipec/inference/__init__.py                 9      9     0%   8-17
mlip_autopipec/inference/analysis.py                44     44     0%   8-90
mlip_autopipec/inference/embedding.py               45     45     0%   1-117
mlip_autopipec/inference/inputs.py                  19     19     0%   7-69
mlip_autopipec/inference/interfaces.py               5      5     0%   5-16
mlip_autopipec/inference/lammps_runner.py           36     36     0%   8-94
mlip_autopipec/inference/masking.py                 33     33     0%   1-72
mlip_autopipec/inference/uq.py                      23     23     0%   1-38
mlip_autopipec/inference/writer.py                  20     20     0%   7-60
mlip_autopipec/modules/__init__.py                   0      0   100%
mlip_autopipec/modules/config_generator.py          15     15     0%   3-74
mlip_autopipec/modules/descriptors.py               31     31     0%   3-62
mlip_autopipec/modules/dft.py                       67     67     0%   6-189
mlip_autopipec/modules/exploration.py               51     51     0%   7-130
mlip_autopipec/modules/explorer.py                  46     46     0%   3-90
mlip_autopipec/modules/generator.py                 72     72     0%   3-203
mlip_autopipec/modules/inference.py                136    136     0%   7-333
mlip_autopipec/modules/screening.py                 41     41     0%   3-68
mlip_autopipec/modules/training.py                  94     94     0%   9-234
mlip_autopipec/monitoring/__init__.py                0      0   100%
mlip_autopipec/monitoring/dashboard.py              63     63     0%   1-115
mlip_autopipec/orchestration/__init__.py             5      0   100%
mlip_autopipec/orchestration/dashboard.py           47     33    30%   31-34, 45-55, 67-95, 108-110
mlip_autopipec/orchestration/interfaces.py           9      0   100%
mlip_autopipec/orchestration/manager.py            136     91    33%   71-73, 92-122, 132-164, 174-211, 221-248, 258-276, 283-302
mlip_autopipec/orchestration/models.py              18      0   100%
mlip_autopipec/orchestration/task_queue.py          41     28    32%   29-38, 54-55, 74-90, 105, 111-114
mlip_autopipec/surrogate/__init__.py                 0      0   100%
mlip_autopipec/surrogate/candidate_manager.py       14      8    43%   15-19, 35-37
mlip_autopipec/surrogate/descriptors.py             30     21    30%   27-28, 44-84
mlip_autopipec/surrogate/mace_client.py             62     51    18%   27-29, 38-61, 76-101, 118-146
mlip_autopipec/surrogate/pipeline.py                54     39    28%   29-33, 49-80, 84-97, 101-106, 112-118
mlip_autopipec/surrogate/sampling.py                28     22    21%   11, 18-19, 28-80
mlip_autopipec/training/__init__.py                  4      0   100%
mlip_autopipec/training/config_gen.py               16     10    38%   12-14, 32-46
mlip_autopipec/training/dataset.py                 104     82    21%   40-41, 56-64, 77-82, 87-99, 107-146, 152-163, 169-180, 196-219
mlip_autopipec/training/pacemaker.py                92     74    20%   36, 63-79, 85-104, 115-120, 124-149, 160-187
mlip_autopipec/training/physics.py                  39     28    28%   43-109
mlip_autopipec/utils/__init__.py                     0      0   100%
mlip_autopipec/utils/ase_utils.py                   42     42     0%   12-120
mlip_autopipec/utils/config_utils.py                 7      7     0%   3-38
mlip_autopipec/utils/dask_utils.py                  12     12     0%   6-43
mlip_autopipec/utils/data_loader.py                 15     15     0%   5-39
mlip_autopipec/utils/resilience.py                  29     29     0%   6-93
mlip_autopipec/utils/workflow_utils.py              32     32     0%   3-53
mlip_autopipec/workflow_manager.py                 106    106     0%   1-191
------------------------------------------------------------------------------
TOTAL                                             3118   2282    27%
=========================== short test summary info ============================
FAILED tests/orchestration/test_manager.py::test_manager_run_max_generations
FAILED tests/integration/test_orchestration_integration.py::test_grand_mock_workflow
FAILED tests/uat/cycle_08_uat.py::test_uat_08_01_end_to_end_autonomous_run - ...
FAILED tests/uat/cycle_08_uat.py::test_uat_08_02_checkpoint_resume - Attribut...
FAILED tests/core/test_database_manager.py::test_db_manager_save_retrieve_candidate
FAILED tests/core/test_database_manager.py::test_db_manager_count - assert 0 ...
========================= 6 failed, 6 passed in 12.25s =========================
