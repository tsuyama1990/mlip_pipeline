============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
plugins: cov-7.0.0
collected 1 item

tests/uat/test_cycle02_full_pipeline.py Created /tmp/pytest-of-jules/pytest-10/test_run_cycle_02_full_pipelin0/tmp1txfwoy7/dummy.UPF, exists: True
CWD: /tmp/pytest-of-jules/pytest-10/test_run_cycle_02_full_pipelin0/tmp1txfwoy7
Files in CWD: [PosixPath('/tmp/pytest-of-jules/pytest-10/test_run_cycle_02_full_pipelin0/tmp1txfwoy7/input.yaml'), PosixPath('/tmp/pytest-of-jules/pytest-10/test_run_cycle_02_full_pipelin0/tmp1txfwoy7/dummy.UPF')]

=== STDOUT ===
[bold blue]Step 1: Structure Generation[/bold blue]
Generated 2 structures.
[bold blue]Step 2: Oracle Calculation & Database Storage[/bold blue]
[yellow]Running in MOCK DFT mode.[/yellow]
Running DFT... ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 0:00:00
[bold blue]Step 3: Training[/bold blue]
[red]Training Failed.[/red]
Cycle 02 Failed:

=== EXCEPTION ===
1
F

=================================== FAILURES ===================================
_______________________ test_run_cycle_02_full_pipeline ________________________

tmp_path = PosixPath('/tmp/pytest-of-jules/pytest-10/test_run_cycle_02_full_pipelin0')

    def test_run_cycle_02_full_pipeline(tmp_path):
        runner = CliRunner()

        config_content = """
    target_system:
      name: Al
      elements: [Al]
      composition: {Al: 1.0}
      crystal_structure: fcc

    generator_config:
      number_of_structures: 2
      seed: 42
      distortion:
        enabled: true
        n_strain_steps: 1
        n_rattle_steps: 1

    dft:
      command: "echo 'mock'"
      pseudopotential_dir: "."

    training_config:
      cutoff: 4.0
      b_basis_size: 10
      kappa: 0.5
      kappa_f: 1.0
      batch_size: 10
      max_iter: 10

    runtime:
      work_dir: "_work_test"
      database_path: "test.db"
    """

        with runner.isolated_filesystem(temp_dir=tmp_path):
            Path("input.yaml").write_text(config_content)
            # Create dummy UPF file to satisfy validation
            upf = Path("dummy.UPF")
            upf.touch()
            print(f"Created {upf.absolute()}, exists: {upf.exists()}")
            print(f"CWD: {Path.cwd()}")
            print(f"Files in CWD: {list(Path.cwd().iterdir())}")

            with patch("mlip_autopipec.training.pacemaker.PacemakerWrapper.train") as mock_train:
                # Mock successful training
                mock_train.return_value = TrainingResult(
                    success=True,
                    potential_path=str(Path("_work_test") / "training" / "output.yace"),
                    metrics=TrainingMetrics(epoch=10, rmse_energy=0.01, rmse_force=0.1)
                )

                result = runner.invoke(app, ["run", "cycle-02", "--config", "input.yaml", "--mock-dft"])

                if result.exit_code != 0:
                    print("\n=== STDOUT ===")
                    print(result.stdout)
                    print("=== EXCEPTION ===")
                    print(result.exception)

>               assert result.exit_code == 0
E               assert 1 == 0
E                +  where 1 = <Result SystemExit(1)>.exit_code

tests/uat/test_cycle02_full_pipeline.py:68: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    mlip_autopipec.training.dataset:dataset.py:112 No atoms found with query 'status=completed'
ERROR    mlip_autopipec.modules.training_orchestrator:training_orchestrator.py:72 Training workflow failed
Traceback (most recent call last):
  File "/app/src/mlip_autopipec/modules/training_orchestrator.py", line 65, in run_training
    builder.export(self.config, self.work_dir)
  File "/app/src/mlip_autopipec/training/dataset.py", line 114, in export
    raise ValueError(msg)
ValueError: No training data found in database.
ERROR    mlip_autopipec:app.py:170 Cycle 02 failed
Traceback (most recent call last):
  File "/app/src/mlip_autopipec/app.py", line 167, in run_cycle_02
    CLIHandler.run_cycle_02(config_file, mock_dft=mock_dft, dry_run=dry_run)
  File "/app/src/mlip_autopipec/modules/cli_handlers/handlers.py", line 398, in run_cycle_02
    raise typer.Exit(code=1)
click.exceptions.Exit
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.12-final-0 _______________

Name                                                     Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------------------
src/mlip_autopipec/__init__.py                               4      0   100%
src/mlip_autopipec/app.py                                  122     80    34%   32-36, 51-63, 74-79, 93-99, 112-118, 128-133, 143-149, 176-177, 189-230, 234
src/mlip_autopipec/config/__init__.py                       12      0   100%
src/mlip_autopipec/config/factory.py                        37     37     0%   1-62
src/mlip_autopipec/config/loaders/__init__.py                2      0   100%
src/mlip_autopipec/config/loaders/yaml_loader.py            58     44    24%   24-45, 53-65, 73-95
src/mlip_autopipec/config/models.py                         48      0   100%
src/mlip_autopipec/config/schemas/common.py                 18      5    72%   8-11, 30
src/mlip_autopipec/config/schemas/core.py                   42     10    76%   21-22, 29-30, 35-36, 40-41, 47-48
src/mlip_autopipec/config/schemas/dft.py                    59     17    71%   50-51, 53-54, 59-60, 67-70, 76-77, 81-85
src/mlip_autopipec/config/schemas/exploration.py             5      0   100%
src/mlip_autopipec/config/schemas/generator.py              28      0   100%
src/mlip_autopipec/config/schemas/inference.py              42      4    90%   76-79
src/mlip_autopipec/config/schemas/monitoring.py             12      0   100%
src/mlip_autopipec/config/schemas/surrogate.py              23      0   100%
src/mlip_autopipec/config/schemas/training.py               40      6    85%   40-41, 43-44, 54-55
src/mlip_autopipec/config/schemas/validation.py             20      0   100%
src/mlip_autopipec/config/schemas/workflow.py                6      0   100%
src/mlip_autopipec/core/__init__.py                          0      0   100%
src/mlip_autopipec/core/services.py                         13      4    69%   24-25, 31-32
src/mlip_autopipec/core/workspace.py                        13     13     0%   1-25
src/mlip_autopipec/dft/__init__.py                           0      0   100%
src/mlip_autopipec/dft/constants.py                          3      0   100%
src/mlip_autopipec/dft/inputs.py                            70     54    23%   32-116, 124-138, 145-148, 155-162
src/mlip_autopipec/dft/parsers.py                           37     29    22%   27, 53-104
src/mlip_autopipec/dft/recovery.py                          42     26    38%   41-48, 55-85
src/mlip_autopipec/dft/runner.py                           155    117    25%   65-71, 74-181, 194-218, 223-245, 248-250, 253-264, 269-270, 275-277
src/mlip_autopipec/domain_models/__init__.py                 5      0   100%
src/mlip_autopipec/domain_models/atoms.py                   36     36     0%   1-68
src/mlip_autopipec/domain_models/candidate.py               10     10     0%   1-19
src/mlip_autopipec/domain_models/dft_models.py              52      6    88%   54, 56-57, 64, 66-67
src/mlip_autopipec/domain_models/inference_models.py        26      9    65%   28-37
src/mlip_autopipec/domain_models/state.py                   14      0   100%
src/mlip_autopipec/domain_models/structure_enums.py          9      9     0%   1-11
src/mlip_autopipec/domain_models/training_data.py           68     41    40%   29-35, 43-64, 69-82, 96-102
src/mlip_autopipec/domain_models/validation.py              15      0   100%
src/mlip_autopipec/exceptions.py                            25     13    48%   43-48, 51-52, 59-60, 63-66
src/mlip_autopipec/generator/__init__.py                     5      0   100%
src/mlip_autopipec/generator/builder.py                     96     30    69%   45-46, 81-82, 106-111, 148-151, 155-165, 184-188, 191-192, 197-198, 202
src/mlip_autopipec/generator/defects.py                     94     75    20%   48-65, 81-128, 144-206
src/mlip_autopipec/generator/distortions.py                 43      7    84%   40-41, 60, 68-69, 81-82
src/mlip_autopipec/generator/sqs.py                         44     10    77%   55, 71, 78-83, 95-98
src/mlip_autopipec/generator/transformations.py             48     21    56%   27-28, 46-55, 76-77, 80, 93-98
src/mlip_autopipec/inference/__init__.py                     8      0   100%
src/mlip_autopipec/inference/analysis.py                    44     39    11%   22, 34-88
src/mlip_autopipec/inference/drivers/pace_driver.py         48     39    19%   11-17, 27-43, 48-82, 86
src/mlip_autopipec/inference/eon.py                         72     55    24%   34-36, 45-57, 66-67, 87-159
src/mlip_autopipec/inference/inputs.py                      35     25    29%   22, 28-105
src/mlip_autopipec/inference/interfaces.py                   5      0   100%
src/mlip_autopipec/inference/masking.py                     36     32    11%   23-77
src/mlip_autopipec/inference/parsers.py                     41     36    12%   30-87
src/mlip_autopipec/inference/processing.py                  40     28    30%   22-24, 39-81
src/mlip_autopipec/inference/runner.py                      83     67    19%   37-40, 54-133, 140-174
src/mlip_autopipec/inference/uq.py                          23     17    26%   9, 16-38
src/mlip_autopipec/inference/writer.py                      21     13    38%   27-29, 42-65
src/mlip_autopipec/modules/__init__.py                       0      0   100%
src/mlip_autopipec/modules/cli_handlers/handlers.py        237    161    32%   28-68, 74-182, 186-188, 192-220, 224-237, 241-273, 277-282, 286-297, 328-329, 336-339, 367-372, 378, 384-385, 394-395
src/mlip_autopipec/modules/training_orchestrator.py         22      2    91%   68-69
src/mlip_autopipec/monitoring/__init__.py                    0      0   100%
src/mlip_autopipec/monitoring/dashboard.py                  64     64     0%   1-118
src/mlip_autopipec/orchestration/__init__.py                 7      0   100%
src/mlip_autopipec/orchestration/dashboard.py               57     37    35%   44-47, 58-68, 80-116, 129-131
src/mlip_autopipec/orchestration/database.py               202    127    37%   42-53, 100-101, 105-106, 111-112, 132-147, 160-168, 178-188, 198-208, 225-234, 250-262, 271, 280, 286, 295-311, 322-323, 338-349, 356-357, 361-374
src/mlip_autopipec/orchestration/interfaces.py              10      0   100%
src/mlip_autopipec/orchestration/phase_executor.py          23     10    57%   20-24, 28, 32, 36, 43, 47
src/mlip_autopipec/orchestration/phases/base.py             10      4    60%   14-17
src/mlip_autopipec/orchestration/phases/dft.py              36     29    19%   13-62
src/mlip_autopipec/orchestration/phases/exploration.py      34     22    35%   17-22, 28-55
src/mlip_autopipec/orchestration/phases/inference.py        54     43    20%   24-90
src/mlip_autopipec/orchestration/phases/selection.py        38     30    21%   17-69
src/mlip_autopipec/orchestration/phases/training.py         39     31    21%   14-58
src/mlip_autopipec/orchestration/strategies.py              27     13    52%   41-43, 49-61
src/mlip_autopipec/orchestration/task_queue.py              77     62    19%   30-52, 69-78, 97-126, 141-144, 150-154
src/mlip_autopipec/orchestration/workflow.py                91     68    25%   46-72, 76-91, 95-101, 105, 111-134, 138-168, 172-183
src/mlip_autopipec/surrogate/__init__.py                     5      0   100%
src/mlip_autopipec/surrogate/candidate_manager.py           18     15    17%   8, 11-28
src/mlip_autopipec/surrogate/descriptors.py                 31     31     0%   1-85
src/mlip_autopipec/surrogate/mace_client.py                 66     66     0%   1-150
src/mlip_autopipec/surrogate/mace_wrapper.py                57     50    12%   11-13, 19-39, 45-67, 73-112
src/mlip_autopipec/surrogate/model_interface.py              8      0   100%
src/mlip_autopipec/surrogate/pipeline.py                   106     90    15%   22-28, 38-59, 63-68, 71-72, 77-127, 132-175
src/mlip_autopipec/surrogate/sampling.py                    19     14    26%   7, 19-45
src/mlip_autopipec/training/__init__.py                      4      0   100%
src/mlip_autopipec/training/config_gen.py                   17     17     0%   1-47
src/mlip_autopipec/training/dataset.py                      54     20    63%   50-57, 99-109, 116-122
src/mlip_autopipec/training/metrics.py                      41     33    20%   34-81
src/mlip_autopipec/training/pacemaker.py                   149    125    16%   39-41, 47-62, 66-101, 105, 109, 113-135, 139-149, 156-213, 221-261
src/mlip_autopipec/training/physics.py                      39     28    28%   43-112
src/mlip_autopipec/utils/__init__.py                         0      0   100%
src/mlip_autopipec/utils/ase_utils.py                       44     44     0%   12-122
src/mlip_autopipec/utils/config_utils.py                    33     22    33%   20, 25-27, 40-60
src/mlip_autopipec/utils/dask_utils.py                      13      8    38%   35-48
src/mlip_autopipec/utils/data_loader.py                     15     15     0%   5-39
src/mlip_autopipec/utils/embedding.py                       46     34    26%   30, 43-49, 53-61, 74-88, 96-126
src/mlip_autopipec/utils/logging.py                         11      4    64%   24-29
src/mlip_autopipec/utils/resilience.py                      30     30     0%   6-94
src/mlip_autopipec/utils/workflow_utils.py                  32     32     0%   3-53
src/mlip_autopipec/validation/__init__.py                    0      0   100%
src/mlip_autopipec/validation/elasticity.py                 49     49     0%   1-116
src/mlip_autopipec/validation/eos.py                        31     31     0%   1-77
src/mlip_autopipec/validation/phonon.py                     36     36     0%   1-104
src/mlip_autopipec/validation/runner.py                     24     24     0%   1-50
--------------------------------------------------------------------------------------
TOTAL                                                     3963   2585    35%
=========================== short test summary info ============================
FAILED tests/uat/test_cycle02_full_pipeline.py::test_run_cycle_02_full_pipeline
============================== 1 failed in 7.26s ===============================
